 CREATE OR REPLACE FUNCTION treinamento.approve_collaborator(_approval_id uuid, _approve boolean)                                                                                                                                                                                                                                                               +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento'                                                                                                                                                                                                                                                                                                                              +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   approval_record record;\r                                                                                                                                                                                                                                                                                                                                    +
   new_status approval_status;\r                                                                                                                                                                                                                                                                                                                                +
   is_authorized boolean := false;\r                                                                                                                                                                                                                                                                                                                            +
   v_unit_code text;\r                                                                                                                                                                                                                                                                                                                                          +
   v_phone text;\r                                                                                                                                                                                                                                                                                                                                              +
   v_name text;\r                                                                                                                                                                                                                                                                                                                                               +
   v_group_id text;\r                                                                                                                                                                                                                                                                                                                                           +
   v_grupo_nome text;\r                                                                                                                                                                                                                                                                                                                                         +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   -- Buscar o registro de aprovação\r                                                                                                                                                                                                                                                                                                                          +
   SELECT * INTO approval_record \r                                                                                                                                                                                                                                                                                                                             +
   FROM treinamento.collaboration_approvals \r                                                                                                                                                                                                                                                                                                                  +
   WHERE id = _approval_id;\r                                                                                                                                                                                                                                                                                                                                   +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF NOT FOUND THEN\r                                                                                                                                                                                                                                                                                                                                          +
     RAISE EXCEPTION 'Approval record not found';\r                                                                                                                                                                                                                                                                                                             +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   -- Verificar autorização (admin ou franqueado da unidade)\r                                                                                                                                                                                                                                                                                                  +
   is_authorized := is_admin(auth.uid());\r                                                                                                                                                                                                                                                                                                                     +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   IF NOT is_authorized THEN\r                                                                                                                                                                                                                                                                                                                                  +
     SELECT EXISTS (\r                                                                                                                                                                                                                                                                                                                                          +
       SELECT 1\r                                                                                                                                                                                                                                                                                                                                               +
       FROM treinamento.users\r                                                                                                                                                                                                                                                                                                                                 +
       WHERE id = auth.uid()\r                                                                                                                                                                                                                                                                                                                                  +
         AND role = 'Franqueado'\r                                                                                                                                                                                                                                                                                                                              +
         AND (\r                                                                                                                                                                                                                                                                                                                                                +
           approval_record.unit_code = ANY(unit_codes) OR\r                                                                                                                                                                                                                                                                                                     +
           approval_record.unit_code = unit_code\r                                                                                                                                                                                                                                                                                                              +
         )\r                                                                                                                                                                                                                                                                                                                                                    +
     ) INTO is_authorized;\r                                                                                                                                                                                                                                                                                                                                    +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF NOT is_authorized THEN\r                                                                                                                                                                                                                                                                                                                                  +
     RAISE EXCEPTION 'Access Denied. Only the franchisee or admin can approve';\r                                                                                                                                                                                                                                                                               +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   -- Definir novo status\r                                                                                                                                                                                                                                                                                                                                     +
   new_status := CASE WHEN _approve THEN 'aprovado'::approval_status ELSE 'rejeitado'::approval_status END;\r                                                                                                                                                                                                                                                   +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   -- Atualizar status na tabela collaboration_approvals\r                                                                                                                                                                                                                                                                                                      +
   UPDATE treinamento.collaboration_approvals\r                                                                                                                                                                                                                                                                                                                 +
   SET status = new_status, updated_at = now()\r                                                                                                                                                                                                                                                                                                                +
   WHERE id = _approval_id;\r                                                                                                                                                                                                                                                                                                                                   +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   -- Atualizar status do colaborador na tabela users\r                                                                                                                                                                                                                                                                                                         +
   UPDATE treinamento.users\r                                                                                                                                                                                                                                                                                                                                   +
   SET \r                                                                                                                                                                                                                                                                                                                                                       +
     approval_status = new_status,\r                                                                                                                                                                                                                                                                                                                            +
     approved_by = CASE WHEN _approve THEN auth.uid() ELSE NULL END,\r                                                                                                                                                                                                                                                                                          +
     approved_at = CASE WHEN _approve THEN now() ELSE NULL END,\r                                                                                                                                                                                                                                                                                               +
     updated_at = now()\r                                                                                                                                                                                                                                                                                                                                       +
   WHERE id = approval_record.collaborator_id;\r                                                                                                                                                                                                                                                                                                                +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   -- Se aprovado, adicionar ao grupo do WhatsApp\r                                                                                                                                                                                                                                                                                                             +
   IF _approve THEN\r                                                                                                                                                                                                                                                                                                                                           +
     -- Buscar dados do colaborador e da unidade\r                                                                                                                                                                                                                                                                                                              +
     SELECT u.unit_code, u.phone, u.name, un.grupo_colaborador, un.grupo\r                                                                                                                                                                                                                                                                                      +
     INTO v_unit_code, v_phone, v_name, v_group_id, v_grupo_nome\r                                                                                                                                                                                                                                                                                              +
     FROM treinamento.users u\r                                                                                                                                                                                                                                                                                                                                 +
     LEFT JOIN treinamento.unidades un ON un.codigo_grupo::text = u.unit_code\r                                                                                                                                                                                                                                                                                 +
     WHERE u.id = approval_record.collaborator_id;\r                                                                                                                                                                                                                                                                                                            +
     \r                                                                                                                                                                                                                                                                                                                                                         +
     -- Log dos dados encontrados\r                                                                                                                                                                                                                                                                                                                             +
     RAISE NOTICE 'Colaborador aprovado - Dados: unit_code=%, phone=%, name=%, group_id=%, grupo_nome=%', \r                                                                                                                                                                                                                                                    +
       v_unit_code, v_phone, v_name, v_group_id, v_grupo_nome;\r                                                                                                                                                                                                                                                                                                +
     \r                                                                                                                                                                                                                                                                                                                                                         +
     -- Se tem telefone e unit_code válido\r                                                                                                                                                                                                                                                                                                                    +
     IF v_phone IS NOT NULL AND v_phone != '' AND v_unit_code IS NOT NULL THEN\r                                                                                                                                                                                                                                                                                +
       -- Se grupo não existe, inserir requisição para criar (será processado por trigger ou job)\r                                                                                                                                                                                                                                                             +
       IF v_group_id IS NULL OR v_group_id = '' THEN\r                                                                                                                                                                                                                                                                                                          +
         RAISE NOTICE 'Grupo não existe para unidade %. Requisição de criação será necessária.', v_unit_code;\r                                                                                                                                                                                                                                                 +
         -- Nota: O grupo deve ser criado via edge function create-collaborator-group\r                                                                                                                                                                                                                                                                         +
         -- que será chamado pela aplicação quando detectar grupo inexistente\r                                                                                                                                                                                                                                                                                 +
       ELSE\r                                                                                                                                                                                                                                                                                                                                                   +
         -- Grupo existe, inserir requisição para adicionar colaborador\r                                                                                                                                                                                                                                                                                       +
         RAISE NOTICE 'Adicionando colaborador ao grupo existente: %', v_group_id;\r                                                                                                                                                                                                                                                                            +
         -- Nota: A aplicação deve chamar add-collaborator-to-group edge function\r                                                                                                                                                                                                                                                                             +
         -- com os dados: groupId=v_group_id, phone=v_phone, name=v_name\r                                                                                                                                                                                                                                                                                      +
       END IF;\r                                                                                                                                                                                                                                                                                                                                                +
     ELSE\r                                                                                                                                                                                                                                                                                                                                                     +
       RAISE NOTICE 'Telefone ou unit_code ausente. Não é possível adicionar ao grupo WhatsApp.';\r                                                                                                                                                                                                                                                             +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.advance_turmas_close(p_now timestamp with time zone)                                                                                                                                                                                                                                                                    +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   RAISE NOTICE 'Advance turmas close called at %', p_now;\r                                                                                                                                                                                                                                                                                                    +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.advance_turmas_open(p_now timestamp with time zone)                                                                                                                                                                                                                                                                     +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   RAISE NOTICE 'Advance turmas open called at %', p_now;\r                                                                                                                                                                                                                                                                                                     +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.approve_admin_user(admin_user_id uuid)                                                                                                                                                                                                                                                                                  +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   IF NOT treinamento.is_admin(auth.uid()) THEN\r                                                                                                                                                                                                                                                                                                               +
     RAISE EXCEPTION 'Access denied. Admin access required.';\r                                                                                                                                                                                                                                                                                                 +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   UPDATE treinamento.admin_users \r                                                                                                                                                                                                                                                                                                                            +
   SET status = 'approved', updated_at = now()\r                                                                                                                                                                                                                                                                                                                +
   WHERE id = admin_user_id AND status = 'pending';\r                                                                                                                                                                                                                                                                                                           +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF NOT FOUND THEN\r                                                                                                                                                                                                                                                                                                                                          +
     RAISE EXCEPTION 'Admin user not found or already processed.';\r                                                                                                                                                                                                                                                                                            +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.authenticate_with_role(p_email text, p_password text, p_role text)                                                                                                                                                                                                                                                      +
  RETURNS jsonb                                                                                                                                                                                                                                                                                                                                                 +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   v_user_id uuid;\r                                                                                                                                                                                                                                                                                                                                            +
   v_is_admin boolean := false;\r                                                                                                                                                                                                                                                                                                                               +
   v_is_professor boolean := false;\r                                                                                                                                                                                                                                                                                                                           +
   v_has_student_profile boolean := false;\r                                                                                                                                                                                                                                                                                                                    +
   v_result jsonb;\r                                                                                                                                                                                                                                                                                                                                            +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT id INTO v_user_id \r                                                                                                                                                                                                                                                                                                                                  +
   FROM auth.users \r                                                                                                                                                                                                                                                                                                                                           +
   WHERE email = p_email;\r                                                                                                                                                                                                                                                                                                                                     +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF v_user_id IS NULL THEN\r                                                                                                                                                                                                                                                                                                                                  +
     RETURN jsonb_build_object(\r                                                                                                                                                                                                                                                                                                                               +
       'success', false,\r                                                                                                                                                                                                                                                                                                                                      +
       'error', 'USER_NOT_FOUND',\r                                                                                                                                                                                                                                                                                                                             +
       'message', 'UsuÃ¡rio nÃ£o encontrado'\r                                                                                                                                                                                                                                                                                                                  +
     );\r                                                                                                                                                                                                                                                                                                                                                       +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   v_is_admin := treinamento.is_admin(v_user_id);\r                                                                                                                                                                                                                                                                                                             +
   v_is_professor := treinamento.is_professor(v_user_id);\r                                                                                                                                                                                                                                                                                                     +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   SELECT EXISTS(\r                                                                                                                                                                                                                                                                                                                                             +
     SELECT 1 FROM treinamento.users WHERE id = v_user_id\r                                                                                                                                                                                                                                                                                                     +
     UNION\r                                                                                                                                                                                                                                                                                                                                                    +
     SELECT 1 FROM treinamento.enrollments WHERE user_id = v_user_id LIMIT 1\r                                                                                                                                                                                                                                                                                  +
   ) INTO v_has_student_profile;\r                                                                                                                                                                                                                                                                                                                              +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   CASE p_role\r                                                                                                                                                                                                                                                                                                                                                +
     WHEN 'Admin' THEN\r                                                                                                                                                                                                                                                                                                                                        +
       IF NOT v_is_admin THEN\r                                                                                                                                                                                                                                                                                                                                 +
         RETURN jsonb_build_object(\r                                                                                                                                                                                                                                                                                                                           +
           'success', false,\r                                                                                                                                                                                                                                                                                                                                  +
           'error', 'ROLE_NOT_GRANTED',\r                                                                                                                                                                                                                                                                                                                       +
           'message', 'UsuÃ¡rio nÃ£o possui permissÃ£o de administrador'\r                                                                                                                                                                                                                                                                                      +
         );\r                                                                                                                                                                                                                                                                                                                                                   +
       END IF;\r                                                                                                                                                                                                                                                                                                                                                +
     WHEN 'Professor' THEN\r                                                                                                                                                                                                                                                                                                                                    +
       IF NOT v_is_professor THEN\r                                                                                                                                                                                                                                                                                                                             +
         RETURN jsonb_build_object(\r                                                                                                                                                                                                                                                                                                                           +
           'success', false,\r                                                                                                                                                                                                                                                                                                                                  +
           'error', 'ROLE_NOT_GRANTED',\r                                                                                                                                                                                                                                                                                                                       +
           'message', 'UsuÃ¡rio nÃ£o possui permissÃ£o de professor'\r                                                                                                                                                                                                                                                                                          +
         );\r                                                                                                                                                                                                                                                                                                                                                   +
       END IF;\r                                                                                                                                                                                                                                                                                                                                                +
     WHEN 'Aluno' THEN\r                                                                                                                                                                                                                                                                                                                                        +
       IF NOT v_has_student_profile THEN\r                                                                                                                                                                                                                                                                                                                      +
         RETURN jsonb_build_object(\r                                                                                                                                                                                                                                                                                                                           +
           'success', false,\r                                                                                                                                                                                                                                                                                                                                  +
           'error', 'ROLE_NOT_GRANTED',\r                                                                                                                                                                                                                                                                                                                       +
           'message', 'UsuÃ¡rio nÃ£o possui perfil de estudante'\r                                                                                                                                                                                                                                                                                              +
         );\r                                                                                                                                                                                                                                                                                                                                                   +
       END IF;\r                                                                                                                                                                                                                                                                                                                                                +
     ELSE\r                                                                                                                                                                                                                                                                                                                                                     +
       RETURN jsonb_build_object(\r                                                                                                                                                                                                                                                                                                                             +
         'success', false,\r                                                                                                                                                                                                                                                                                                                                    +
         'error', 'INVALID_ROLE',\r                                                                                                                                                                                                                                                                                                                             +
         'message', 'Papel invÃ¡lido'\r                                                                                                                                                                                                                                                                                                                         +
       );\r                                                                                                                                                                                                                                                                                                                                                     +
   END CASE;\r                                                                                                                                                                                                                                                                                                                                                  +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   RETURN jsonb_build_object(\r                                                                                                                                                                                                                                                                                                                                 +
     'success', true,\r                                                                                                                                                                                                                                                                                                                                         +
     'user_id', v_user_id,\r                                                                                                                                                                                                                                                                                                                                    +
     'act_as', CASE p_role\r                                                                                                                                                                                                                                                                                                                                    +
       WHEN 'Admin' THEN 'admin'\r                                                                                                                                                                                                                                                                                                                              +
       WHEN 'Professor' THEN 'teacher'\r                                                                                                                                                                                                                                                                                                                        +
       WHEN 'Aluno' THEN 'student'\r                                                                                                                                                                                                                                                                                                                            +
     END,\r                                                                                                                                                                                                                                                                                                                                                     +
     'permissions', jsonb_build_object(\r                                                                                                                                                                                                                                                                                                                       +
       'is_admin', v_is_admin,\r                                                                                                                                                                                                                                                                                                                                +
       'is_professor', v_is_professor,\r                                                                                                                                                                                                                                                                                                                        +
       'has_student_profile', v_has_student_profile\r                                                                                                                                                                                                                                                                                                           +
     )\r                                                                                                                                                                                                                                                                                                                                                        +
   );\r                                                                                                                                                                                                                                                                                                                                                         +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.backfill_users_unit_code()                                                                                                                                                                                                                                                                                              +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   UPDATE treinamento.users u\r                                                                                                                                                                                                                                                                                                                                 +
   SET unit_code = (\r                                                                                                                                                                                                                                                                                                                                          +
     SELECT au.raw_user_meta_data ->> 'unit_code'\r                                                                                                                                                                                                                                                                                                             +
     FROM auth.users au\r                                                                                                                                                                                                                                                                                                                                       +
     WHERE au.id = u.id\r                                                                                                                                                                                                                                                                                                                                       +
   )\r                                                                                                                                                                                                                                                                                                                                                          +
   WHERE u.unit_code IS NULL;\r                                                                                                                                                                                                                                                                                                                                 +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.can_enroll_in_turma(p_user uuid, p_turma uuid)                                                                                                                                                                                                                                                                          +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   v_course UUID;\r                                                                                                                                                                                                                                                                                                                                             +
   v_status TEXT;\r                                                                                                                                                                                                                                                                                                                                             +
   v_open TIMESTAMPTZ;\r                                                                                                                                                                                                                                                                                                                                        +
   v_close TIMESTAMPTZ;\r                                                                                                                                                                                                                                                                                                                                       +
   v_capacity INTEGER;\r                                                                                                                                                                                                                                                                                                                                        +
   v_now TIMESTAMPTZ := now();\r                                                                                                                                                                                                                                                                                                                                +
   v_tipo TEXT;\r                                                                                                                                                                                                                                                                                                                                               +
   v_current_count INT;\r                                                                                                                                                                                                                                                                                                                                       +
   v_has_other INT;\r                                                                                                                                                                                                                                                                                                                                           +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT t.course_id, t.status::text, t.enrollment_open_at, t.enrollment_close_at, t.capacity,\r                                                                                                                                                                                                                                                               +
          c.tipo\r                                                                                                                                                                                                                                                                                                                                              +
   INTO   v_course, v_status, v_open, v_close, v_capacity, v_tipo\r                                                                                                                                                                                                                                                                                             +
   FROM turmas t\r                                                                                                                                                                                                                                                                                                                                              +
   JOIN courses c ON c.id = t.course_id\r                                                                                                                                                                                                                                                                                                                       +
   WHERE t.id = p_turma;\r                                                                                                                                                                                                                                                                                                                                      +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   IF NOT FOUND OR v_tipo <> 'ao_vivo' THEN\r                                                                                                                                                                                                                                                                                                                   +
     RETURN FALSE;\r                                                                                                                                                                                                                                                                                                                                            +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   IF v_status NOT IN ('agendada', 'em_andamento') THEN\r                                                                                                                                                                                                                                                                                                       +
     RETURN FALSE;\r                                                                                                                                                                                                                                                                                                                                            +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   IF v_open IS NOT NULL AND v_close IS NOT NULL THEN\r                                                                                                                                                                                                                                                                                                         +
     IF NOT (v_now >= v_open AND v_now < v_close) THEN\r                                                                                                                                                                                                                                                                                                        +
       RETURN FALSE;\r                                                                                                                                                                                                                                                                                                                                          +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   IF v_capacity IS NOT NULL THEN\r                                                                                                                                                                                                                                                                                                                             +
     SELECT COUNT(*) INTO v_current_count\r                                                                                                                                                                                                                                                                                                                     +
     FROM enrollments e\r                                                                                                                                                                                                                                                                                                                                       +
     WHERE e.turma_id = p_turma;\r                                                                                                                                                                                                                                                                                                                              +
     IF v_current_count >= v_capacity THEN\r                                                                                                                                                                                                                                                                                                                    +
       RETURN FALSE;\r                                                                                                                                                                                                                                                                                                                                          +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   SELECT COUNT(*) INTO v_has_other\r                                                                                                                                                                                                                                                                                                                           +
   FROM enrollments e\r                                                                                                                                                                                                                                                                                                                                         +
   WHERE e.user_id = p_user\r                                                                                                                                                                                                                                                                                                                                   +
     AND e.course_id = v_course\r                                                                                                                                                                                                                                                                                                                               +
     AND e.turma_id IS NOT NULL;\r                                                                                                                                                                                                                                                                                                                              +
   IF v_has_other > 0 THEN\r                                                                                                                                                                                                                                                                                                                                    +
     RETURN FALSE;\r                                                                                                                                                                                                                                                                                                                                            +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   RETURN TRUE;\r                                                                                                                                                                                                                                                                                                                                               +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.can_user_access_course(p_user_id uuid, p_course_id uuid)                                                                                                                                                                                                                                                                +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   v_user RECORD;\r                                                                                                                                                                                                                                                                                                                                             +
   v_course RECORD;\r                                                                                                                                                                                                                                                                                                                                           +
   v_user_position TEXT;\r                                                                                                                                                                                                                                                                                                                                      +
   v_has_access BOOLEAN := false;\r                                                                                                                                                                                                                                                                                                                             +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT * INTO v_user FROM treinamento.users WHERE id = p_user_id;\r                                                                                                                                                                                                                                                                                          +
   IF NOT FOUND THEN\r                                                                                                                                                                                                                                                                                                                                          +
     RETURN false;\r                                                                                                                                                                                                                                                                                                                                            +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   SELECT * INTO v_course FROM treinamento.courses WHERE id = p_course_id;\r                                                                                                                                                                                                                                                                                    +
   IF NOT FOUND THEN\r                                                                                                                                                                                                                                                                                                                                          +
     RETURN false;\r                                                                                                                                                                                                                                                                                                                                            +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF v_user.user_type = 'Aluno' AND v_user.role = 'Franqueado' THEN\r                                                                                                                                                                                                                                                                                          +
     v_user_position := treinamento.get_franchisee_position(v_user.unit_code);\r                                                                                                                                                                                                                                                                                +
   ELSIF v_user.user_type = 'Aluno' AND v_user.role = 'Colaborador' THEN\r                                                                                                                                                                                                                                                                                      +
     v_user_position := CASE v_user.position\r                                                                                                                                                                                                                                                                                                                  +
       WHEN 'Atendente de Loja' THEN 'ATEND_LOJA'\r                                                                                                                                                                                                                                                                                                             +
       WHEN 'MÃ­dias Sociais' THEN 'MIDIAS_SOC'\r                                                                                                                                                                                                                                                                                                                +
       WHEN 'Operador(a) de Caixa' THEN 'OP_CAIXA'\r                                                                                                                                                                                                                                                                                                            +
       WHEN 'Avaliadora' THEN 'AVALIADORA'\r                                                                                                                                                                                                                                                                                                                    +
       WHEN 'Repositor(a)' THEN 'REPOSITOR'\r                                                                                                                                                                                                                                                                                                                   +
       WHEN 'LÃ­der de Loja' THEN 'LIDER_LOJA'\r                                                                                                                                                                                                                                                                                                                 +
       WHEN 'Gerente' THEN 'GERENTE'\r                                                                                                                                                                                                                                                                                                                          +
       ELSE NULL\r                                                                                                                                                                                                                                                                                                                                              +
     END;\r                                                                                                                                                                                                                                                                                                                                                     +
   ELSE\r                                                                                                                                                                                                                                                                                                                                                       +
     RETURN true;\r                                                                                                                                                                                                                                                                                                                                             +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF v_course.public_target = 'ambos' THEN\r                                                                                                                                                                                                                                                                                                                   +
     SELECT EXISTS(\r                                                                                                                                                                                                                                                                                                                                           +
       SELECT 1 FROM treinamento.course_position_access cpa\r                                                                                                                                                                                                                                                                                                   +
       WHERE cpa.course_id = p_course_id AND cpa.active = true\r                                                                                                                                                                                                                                                                                                +
     ) INTO v_has_access;\r                                                                                                                                                                                                                                                                                                                                     +
     \r                                                                                                                                                                                                                                                                                                                                                         +
     IF NOT v_has_access THEN\r                                                                                                                                                                                                                                                                                                                                 +
       RETURN true;\r                                                                                                                                                                                                                                                                                                                                           +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                  +
     \r                                                                                                                                                                                                                                                                                                                                                         +
   ELSIF v_course.public_target = 'franqueado' AND v_user.role = 'Franqueado' THEN\r                                                                                                                                                                                                                                                                            +
     SELECT EXISTS(\r                                                                                                                                                                                                                                                                                                                                           +
       SELECT 1 FROM treinamento.course_position_access cpa\r                                                                                                                                                                                                                                                                                                   +
       WHERE cpa.course_id = p_course_id AND cpa.active = true\r                                                                                                                                                                                                                                                                                                +
     ) INTO v_has_access;\r                                                                                                                                                                                                                                                                                                                                     +
     \r                                                                                                                                                                                                                                                                                                                                                         +
     IF NOT v_has_access THEN\r                                                                                                                                                                                                                                                                                                                                 +
       RETURN true;\r                                                                                                                                                                                                                                                                                                                                           +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                  +
     \r                                                                                                                                                                                                                                                                                                                                                         +
   ELSIF v_course.public_target = 'colaborador' AND v_user.role = 'Colaborador' THEN\r                                                                                                                                                                                                                                                                          +
     SELECT EXISTS(\r                                                                                                                                                                                                                                                                                                                                           +
       SELECT 1 FROM treinamento.course_position_access cpa\r                                                                                                                                                                                                                                                                                                   +
       WHERE cpa.course_id = p_course_id AND cpa.active = true\r                                                                                                                                                                                                                                                                                                +
     ) INTO v_has_access;\r                                                                                                                                                                                                                                                                                                                                     +
     \r                                                                                                                                                                                                                                                                                                                                                         +
     IF NOT v_has_access THEN\r                                                                                                                                                                                                                                                                                                                                 +
       RETURN true;\r                                                                                                                                                                                                                                                                                                                                           +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                  +
   ELSE\r                                                                                                                                                                                                                                                                                                                                                       +
     RETURN false;\r                                                                                                                                                                                                                                                                                                                                            +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF v_user_position IS NOT NULL THEN\r                                                                                                                                                                                                                                                                                                                        +
     SELECT EXISTS(\r                                                                                                                                                                                                                                                                                                                                           +
       SELECT 1 FROM treinamento.course_position_access cpa\r                                                                                                                                                                                                                                                                                                   +
       WHERE cpa.course_id = p_course_id \r                                                                                                                                                                                                                                                                                                                     +
         AND cpa.position_code = v_user_position \r                                                                                                                                                                                                                                                                                                             +
         AND cpa.active = true\r                                                                                                                                                                                                                                                                                                                                +
     ) INTO v_has_access;\r                                                                                                                                                                                                                                                                                                                                     +
     \r                                                                                                                                                                                                                                                                                                                                                         +
     RETURN v_has_access;\r                                                                                                                                                                                                                                                                                                                                     +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   RETURN false;\r                                                                                                                                                                                                                                                                                                                                              +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.conclude_turma(p_turma_id uuid, p_user_id uuid)                                                                                                                                                                                                                                                                         +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   v_course_id UUID;\r                                                                                                                                                                                                                                                                                                                                          +
   v_turma_record RECORD;\r                                                                                                                                                                                                                                                                                                                                     +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT * INTO v_turma_record FROM treinamento.turmas WHERE id = p_turma_id;\r                                                                                                                                                                                                                                                                                +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF NOT FOUND THEN\r                                                                                                                                                                                                                                                                                                                                          +
     RAISE EXCEPTION 'Turma not found';\r                                                                                                                                                                                                                                                                                                                       +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF v_turma_record.status != 'em_andamento' THEN\r                                                                                                                                                                                                                                                                                                            +
     RAISE EXCEPTION 'Only turmas in progress can be concluded';\r                                                                                                                                                                                                                                                                                              +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   UPDATE treinamento.turmas\r                                                                                                                                                                                                                                                                                                                                  +
   SET \r                                                                                                                                                                                                                                                                                                                                                       +
     status = 'encerrada', \r                                                                                                                                                                                                                                                                                                                                   +
     end_at = now(), \r                                                                                                                                                                                                                                                                                                                                         +
     updated_at = now()\r                                                                                                                                                                                                                                                                                                                                       +
   WHERE id = p_turma_id;\r                                                                                                                                                                                                                                                                                                                                     +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   INSERT INTO treinamento.transformation_kanban (course_id, turma_id, status, created_by)\r                                                                                                                                                                                                                                                                    +
   VALUES (v_turma_record.course_id, p_turma_id, 'Pronto para virar treinamento', p_user_id);\r                                                                                                                                                                                                                                                                 +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.create_class_audit_log()                                                                                                                                                                                                                                                                                                +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   IF TG_OP = 'INSERT' THEN\r                                                                                                                                                                                                                                                                                                                                   +
     INSERT INTO treinamento.class_audit_logs (class_id, action, performed_by, new_data)\r                                                                                                                                                                                                                                                                      +
     VALUES (NEW.id, 'created', auth.uid(), to_jsonb(NEW));\r                                                                                                                                                                                                                                                                                                   +
     RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                              +
   ELSIF TG_OP = 'UPDATE' THEN\r                                                                                                                                                                                                                                                                                                                                +
     INSERT INTO treinamento.class_audit_logs (class_id, action, performed_by, old_data, new_data)\r                                                                                                                                                                                                                                                            +
     VALUES (NEW.id, 'updated', auth.uid(), to_jsonb(OLD), to_jsonb(NEW));\r                                                                                                                                                                                                                                                                                    +
     RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                              +
   ELSIF TG_OP = 'DELETE' THEN\r                                                                                                                                                                                                                                                                                                                                +
     INSERT INTO treinamento.class_audit_logs (class_id, action, performed_by, old_data)\r                                                                                                                                                                                                                                                                      +
     VALUES (OLD.id, 'deleted', auth.uid(), to_jsonb(OLD));\r                                                                                                                                                                                                                                                                                                   +
     RETURN OLD;\r                                                                                                                                                                                                                                                                                                                                              +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   RETURN NULL;\r                                                                                                                                                                                                                                                                                                                                               +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.enroll_student_in_class(_class_id uuid, _student_id uuid)                                                                                                                                                                                                                                                               +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   _class_record RECORD;\r                                                                                                                                                                                                                                                                                                                                      +
   _student_count INTEGER;\r                                                                                                                                                                                                                                                                                                                                    +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT * INTO _class_record FROM treinamento.classes WHERE id = _class_id;\r                                                                                                                                                                                                                                                                                 +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF NOT FOUND THEN\r                                                                                                                                                                                                                                                                                                                                          +
     RAISE EXCEPTION 'Turma nÃ£o encontrada';\r                                                                                                                                                                                                                                                                                                                 +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF _class_record.status = 'encerrada' THEN\r                                                                                                                                                                                                                                                                                                                 +
     RAISE EXCEPTION 'NÃ£o Ã© possÃ­vel inscrever-se em uma turma encerrada';\r                                                                                                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   SELECT COUNT(*) INTO _student_count \r                                                                                                                                                                                                                                                                                                                       +
   FROM treinamento.student_classes \r                                                                                                                                                                                                                                                                                                                          +
   WHERE class_id = _class_id AND status = 'inscrito';\r                                                                                                                                                                                                                                                                                                        +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF _student_count >= COALESCE(_class_record.max_students, 30) THEN\r                                                                                                                                                                                                                                                                                         +
     RAISE EXCEPTION 'Turma lotada. Limite de alunos atingido.';\r                                                                                                                                                                                                                                                                                              +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF EXISTS (\r                                                                                                                                                                                                                                                                                                                                                +
     SELECT 1 FROM treinamento.student_classes \r                                                                                                                                                                                                                                                                                                               +
     WHERE class_id = _class_id AND student_id = _student_id\r                                                                                                                                                                                                                                                                                                  +
   ) THEN\r                                                                                                                                                                                                                                                                                                                                                     +
     RAISE EXCEPTION 'Aluno jÃ¡ estÃ¡ inscrito nesta turma';\r                                                                                                                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   INSERT INTO treinamento.student_classes (class_id, student_id)\r                                                                                                                                                                                                                                                                                             +
   VALUES (_class_id, _student_id);\r                                                                                                                                                                                                                                                                                                                           +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   INSERT INTO treinamento.class_audit_logs (class_id, action, performed_by, new_data)\r                                                                                                                                                                                                                                                                        +
   VALUES (_class_id, 'student_enrolled', auth.uid(), \r                                                                                                                                                                                                                                                                                                        +
     jsonb_build_object('student_id', _student_id, 'enrolled_at', now()));\r                                                                                                                                                                                                                                                                                    +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.ensure_admin_bootstrap()                                                                                                                                                                                                                                                                                                +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   v_count integer;\r                                                                                                                                                                                                                                                                                                                                           +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT COUNT(*) INTO v_count \r                                                                                                                                                                                                                                                                                                                              +
   FROM treinamento.admin_users \r                                                                                                                                                                                                                                                                                                                              +
   WHERE active = true AND status = 'approved';\r                                                                                                                                                                                                                                                                                                               +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF v_count > 0 THEN\r                                                                                                                                                                                                                                                                                                                                        +
     RETURN;\r                                                                                                                                                                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   RETURN;\r                                                                                                                                                                                                                                                                                                                                                    +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.fill_enrollment_unit_code()                                                                                                                                                                                                                                                                                             +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   IF NEW.user_id IS NOT NULL THEN\r                                                                                                                                                                                                                                                                                                                            +
     SELECT unit_code INTO NEW.unit_code \r                                                                                                                                                                                                                                                                                                                     +
     FROM treinamento.users \r                                                                                                                                                                                                                                                                                                                                  +
     WHERE id = NEW.user_id;\r                                                                                                                                                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF NEW.unit_code IS NULL AND NEW.student_email IS NOT NULL THEN\r                                                                                                                                                                                                                                                                                            +
     SELECT unit_code INTO NEW.unit_code \r                                                                                                                                                                                                                                                                                                                     +
     FROM treinamento.users \r                                                                                                                                                                                                                                                                                                                                  +
     WHERE email = NEW.student_email \r                                                                                                                                                                                                                                                                                                                         +
     LIMIT 1;\r                                                                                                                                                                                                                                                                                                                                                 +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.find_franchisee_by_unit_code(_unit_code text)                                                                                                                                                                                                                                                                           +
  RETURNS uuid                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   franchisee_id uuid;\r                                                                                                                                                                                                                                                                                                                                        +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT id INTO franchisee_id\r                                                                                                                                                                                                                                                                                                                               +
   FROM treinamento.users\r                                                                                                                                                                                                                                                                                                                                     +
   WHERE (\r                                                                                                                                                                                                                                                                                                                                                    +
     unit_code = _unit_code OR \r                                                                                                                                                                                                                                                                                                                               +
     _unit_code = ANY(unit_codes)\r                                                                                                                                                                                                                                                                                                                             +
   )\r                                                                                                                                                                                                                                                                                                                                                          +
     AND role = 'Franqueado'\r                                                                                                                                                                                                                                                                                                                                  +
     AND active = true\r                                                                                                                                                                                                                                                                                                                                        +
   LIMIT 1;\r                                                                                                                                                                                                                                                                                                                                                   +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   RETURN franchisee_id;\r                                                                                                                                                                                                                                                                                                                                      +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.force_close_turma_enrollments(p_turma_id uuid, p_user_id uuid)                                                                                                                                                                                                                                                          +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   v_turma_record RECORD;\r                                                                                                                                                                                                                                                                                                                                     +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT * INTO v_turma_record FROM treinamento.turmas WHERE id = p_turma_id;\r                                                                                                                                                                                                                                                                                +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF NOT FOUND THEN\r                                                                                                                                                                                                                                                                                                                                          +
     RAISE EXCEPTION 'Turma not found';\r                                                                                                                                                                                                                                                                                                                       +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF NOT (treinamento.is_admin(p_user_id) OR v_turma_record.responsavel_user_id = p_user_id) THEN\r                                                                                                                                                                                                                                                            +
     RAISE EXCEPTION 'Access denied. Only admins or responsible professors can close enrollments.';\r                                                                                                                                                                                                                                                           +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   UPDATE treinamento.turmas\r                                                                                                                                                                                                                                                                                                                                  +
   SET \r                                                                                                                                                                                                                                                                                                                                                       +
     status = 'encerrada', \r                                                                                                                                                                                                                                                                                                                                   +
     updated_at = now()\r                                                                                                                                                                                                                                                                                                                                       +
   WHERE id = p_turma_id;\r                                                                                                                                                                                                                                                                                                                                     +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.get_email_by_phone(p_phone text)                                                                                                                                                                                                                                                                                        +
  RETURNS text                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   v_email text;\r                                                                                                                                                                                                                                                                                                                                              +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT email INTO v_email\r                                                                                                                                                                                                                                                                                                                                  +
   FROM treinamento.users\r                                                                                                                                                                                                                                                                                                                                     +
   WHERE phone = p_phone\r                                                                                                                                                                                                                                                                                                                                      +
     AND active = true\r                                                                                                                                                                                                                                                                                                                                        +
   LIMIT 1;\r                                                                                                                                                                                                                                                                                                                                                   +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   RETURN v_email;\r                                                                                                                                                                                                                                                                                                                                            +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.get_franchisee_position(p_unit_code text)                                                                                                                                                                                                                                                                               +
  RETURNS text                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   v_fase_loja TEXT;\r                                                                                                                                                                                                                                                                                                                                          +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT fase_loja INTO v_fase_loja\r                                                                                                                                                                                                                                                                                                                          +
   FROM treinamento.unidades\r                                                                                                                                                                                                                                                                                                                                  +
   WHERE id = p_unit_code OR grupo = p_unit_code\r                                                                                                                                                                                                                                                                                                              +
   LIMIT 1;\r                                                                                                                                                                                                                                                                                                                                                   +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   CASE\r                                                                                                                                                                                                                                                                                                                                                       +
     WHEN v_fase_loja = 'IMPLANTAÃ‡ÃƒO' THEN\r                                                                                                                                                                                                                                                                                                                  +
       RETURN 'FRANQ_IMPLANT';\r                                                                                                                                                                                                                                                                                                                                +
     WHEN v_fase_loja = 'OPERAÃ‡ÃƒO' THEN\r                                                                                                                                                                                                                                                                                                                     +
       RETURN 'FRANQ_OPER';\r                                                                                                                                                                                                                                                                                                                                   +
     ELSE\r                                                                                                                                                                                                                                                                                                                                                     +
       RETURN 'FRANQ_GERAL';\r                                                                                                                                                                                                                                                                                                                                  +
   END CASE;\r                                                                                                                                                                                                                                                                                                                                                  +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.get_franchisee_unit_codes(_franchisee_id uuid)                                                                                                                                                                                                                                                                          +
  RETURNS text[]                                                                                                                                                                                                                                                                                                                                                +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                  +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                       +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
   SELECT COALESCE(unit_codes, ARRAY[unit_code]) \r                                                                                                                                                                                                                                                                                                             +
   FROM treinamento.users \r                                                                                                                                                                                                                                                                                                                                    +
   WHERE id = _franchisee_id \r                                                                                                                                                                                                                                                                                                                                 +
     AND role = 'Franqueado' \r                                                                                                                                                                                                                                                                                                                                 +
     AND active = true;\r                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.get_pending_admin_approvals()                                                                                                                                                                                                                                                                                           +
  RETURNS TABLE(id uuid, user_id uuid, name text, email text, role text, created_at timestamp with time zone)                                                                                                                                                                                                                                                   +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                  +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                       +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
   SELECT \r                                                                                                                                                                                                                                                                                                                                                    +
     au.id,\r                                                                                                                                                                                                                                                                                                                                                   +
     au.user_id,\r                                                                                                                                                                                                                                                                                                                                              +
     au.name,\r                                                                                                                                                                                                                                                                                                                                                 +
     au.email,\r                                                                                                                                                                                                                                                                                                                                                +
     au.role,\r                                                                                                                                                                                                                                                                                                                                                 +
     au.created_at\r                                                                                                                                                                                                                                                                                                                                            +
   FROM treinamento.admin_users au\r                                                                                                                                                                                                                                                                                                                            +
   WHERE au.status = 'pending'\r                                                                                                                                                                                                                                                                                                                                +
     AND au.active = true\r                                                                                                                                                                                                                                                                                                                                     +
   ORDER BY au.created_at ASC;\r                                                                                                                                                                                                                                                                                                                                +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.get_professor_accessible_turmas(_professor_id uuid)                                                                                                                                                                                                                                                                     +
  RETURNS TABLE(turma_id uuid, turma_name text, can_view boolean, can_edit boolean, can_manage_students boolean)                                                                                                                                                                                                                                                +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                  +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                       +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
   SELECT \r                                                                                                                                                                                                                                                                                                                                                    +
     ptp.turma_id,\r                                                                                                                                                                                                                                                                                                                                            +
     t.name as turma_name,\r                                                                                                                                                                                                                                                                                                                                    +
     ptp.can_view,\r                                                                                                                                                                                                                                                                                                                                            +
     ptp.can_edit,\r                                                                                                                                                                                                                                                                                                                                            +
     ptp.can_manage_students\r                                                                                                                                                                                                                                                                                                                                  +
   FROM professor_turma_permissions ptp\r                                                                                                                                                                                                                                                                                                                       +
   JOIN turmas t ON t.id = ptp.turma_id\r                                                                                                                                                                                                                                                                                                                       +
   WHERE ptp.professor_id = _professor_id\r                                                                                                                                                                                                                                                                                                                     +
     AND ptp.can_view = true\r                                                                                                                                                                                                                                                                                                                                  +
   ORDER BY t.name;\r                                                                                                                                                                                                                                                                                                                                           +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.get_professor_enabled_fields(_professor_id uuid, _module_name text)                                                                                                                                                                                                                                                     +
  RETURNS jsonb                                                                                                                                                                                                                                                                                                                                                 +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                  +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                       +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
   SELECT COALESCE(\r                                                                                                                                                                                                                                                                                                                                           +
     (SELECT enabled_fields FROM professor_permissions WHERE professor_id = _professor_id AND module_name = _module_name),\r                                                                                                                                                                                                                                    +
     '{}'::jsonb\r                                                                                                                                                                                                                                                                                                                                              +
   );\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.get_system_settings()                                                                                                                                                                                                                                                                                                   +
  RETURNS TABLE(id uuid, system_name text, system_description text, email_notifications boolean, whatsapp_notifications boolean, auto_certificate_generation boolean, certificate_template text, course_approval_required boolean, max_enrollment_per_course integer, timezone text, created_at timestamp with time zone, updated_at timestamp with time zone)  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   RETURN QUERY\r                                                                                                                                                                                                                                                                                                                                               +
   SELECT \r                                                                                                                                                                                                                                                                                                                                                    +
     s.id,\r                                                                                                                                                                                                                                                                                                                                                    +
     s.system_name,\r                                                                                                                                                                                                                                                                                                                                           +
     s.system_description,\r                                                                                                                                                                                                                                                                                                                                    +
     s.email_notifications,\r                                                                                                                                                                                                                                                                                                                                   +
     s.whatsapp_notifications,\r                                                                                                                                                                                                                                                                                                                                +
     s.auto_certificate_generation,\r                                                                                                                                                                                                                                                                                                                           +
     s.certificate_template,\r                                                                                                                                                                                                                                                                                                                                  +
     s.course_approval_required,\r                                                                                                                                                                                                                                                                                                                              +
     s.max_enrollment_per_course,\r                                                                                                                                                                                                                                                                                                                             +
     s.timezone,\r                                                                                                                                                                                                                                                                                                                                              +
     s.created_at,\r                                                                                                                                                                                                                                                                                                                                            +
     s.updated_at\r                                                                                                                                                                                                                                                                                                                                             +
   FROM treinamento.system_settings s\r                                                                                                                                                                                                                                                                                                                         +
   LIMIT 1;\r                                                                                                                                                                                                                                                                                                                                                   +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.has_professor_permission(_professor_id uuid, _module_name text, _permission_type text DEFAULT 'view'::text)                                                                                                                                                                                                             +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                  +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                       +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
   SELECT \r                                                                                                                                                                                                                                                                                                                                                    +
     CASE \r                                                                                                                                                                                                                                                                                                                                                    +
       WHEN _permission_type = 'edit' THEN \r                                                                                                                                                                                                                                                                                                                   +
         COALESCE((SELECT can_edit FROM professor_permissions WHERE professor_id = _professor_id AND module_name = _module_name), false)\r                                                                                                                                                                                                                      +
       ELSE \r                                                                                                                                                                                                                                                                                                                                                  +
         COALESCE((SELECT can_view FROM professor_permissions WHERE professor_id = _professor_id AND module_name = _module_name), false)\r                                                                                                                                                                                                                      +
     END;\r                                                                                                                                                                                                                                                                                                                                                     +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.is_professor(_user uuid)                                                                                                                                                                                                                                                                                                +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                  +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                       +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
   SELECT EXISTS (\r                                                                                                                                                                                                                                                                                                                                            +
     SELECT 1\r                                                                                                                                                                                                                                                                                                                                                 +
     FROM treinamento.users u\r                                                                                                                                                                                                                                                                                                                                 +
     WHERE u.id = _user\r                                                                                                                                                                                                                                                                                                                                       +
       AND u.user_type = 'Professor'\r                                                                                                                                                                                                                                                                                                                          +
       AND u.active = true\r                                                                                                                                                                                                                                                                                                                                    +
   );\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.link_enrollments_on_signup()                                                                                                                                                                                                                                                                                            +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   user_email text;\r                                                                                                                                                                                                                                                                                                                                           +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT email INTO user_email FROM auth.users WHERE id = NEW.id;\r                                                                                                                                                                                                                                                                                            +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   UPDATE treinamento.enrollments \r                                                                                                                                                                                                                                                                                                                            +
   SET user_id = NEW.id\r                                                                                                                                                                                                                                                                                                                                       +
   WHERE student_email = user_email \r                                                                                                                                                                                                                                                                                                                          +
     AND user_id IS NULL;\r                                                                                                                                                                                                                                                                                                                                     +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.link_enrollments_on_user_creation()                                                                                                                                                                                                                                                                                     +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   UPDATE treinamento.enrollments \r                                                                                                                                                                                                                                                                                                                            +
   SET user_id = NEW.id\r                                                                                                                                                                                                                                                                                                                                       +
   WHERE student_email = NEW.email \r                                                                                                                                                                                                                                                                                                                           +
     AND user_id IS NULL;\r                                                                                                                                                                                                                                                                                                                                     +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.manage_class_status(_class_id uuid, _new_status class_status)                                                                                                                                                                                                                                                           +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   _class_record RECORD;\r                                                                                                                                                                                                                                                                                                                                      +
   _current_time TIMESTAMP WITH TIME ZONE := now();\r                                                                                                                                                                                                                                                                                                           +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT * INTO _class_record FROM treinamento.classes WHERE id = _class_id;\r                                                                                                                                                                                                                                                                                 +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF NOT FOUND THEN\r                                                                                                                                                                                                                                                                                                                                          +
     RAISE EXCEPTION 'Turma nÃ£o encontrada';\r                                                                                                                                                                                                                                                                                                                 +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF NOT (treinamento.is_admin(auth.uid()) OR _class_record.responsible_id = auth.uid()) THEN\r                                                                                                                                                                                                                                                                +
     RAISE EXCEPTION 'Acesso negado. Apenas admins ou responsÃ¡veis podem alterar o status da turma.';\r                                                                                                                                                                                                                                                        +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF _new_status = 'iniciada' THEN\r                                                                                                                                                                                                                                                                                                                           +
     UPDATE treinamento.classes \r                                                                                                                                                                                                                                                                                                                              +
     SET status = _new_status, started_at = _current_time, updated_at = _current_time\r                                                                                                                                                                                                                                                                         +
     WHERE id = _class_id;\r                                                                                                                                                                                                                                                                                                                                    +
     \r                                                                                                                                                                                                                                                                                                                                                         +
     INSERT INTO treinamento.class_audit_logs (class_id, action, performed_by, new_data)\r                                                                                                                                                                                                                                                                      +
     VALUES (_class_id, 'started', auth.uid(), jsonb_build_object('started_at', _current_time));\r                                                                                                                                                                                                                                                              +
     \r                                                                                                                                                                                                                                                                                                                                                         +
   ELSIF _new_status = 'encerrada' THEN\r                                                                                                                                                                                                                                                                                                                       +
     UPDATE treinamento.classes \r                                                                                                                                                                                                                                                                                                                              +
     SET status = _new_status, ended_at = _current_time, updated_at = _current_time\r                                                                                                                                                                                                                                                                           +
     WHERE id = _class_id;\r                                                                                                                                                                                                                                                                                                                                    +
     \r                                                                                                                                                                                                                                                                                                                                                         +
     UPDATE treinamento.courses \r                                                                                                                                                                                                                                                                                                                              +
     SET status = 'Pronto para virar treinamento', updated_at = _current_time\r                                                                                                                                                                                                                                                                                 +
     WHERE id = _class_record.course_id;\r                                                                                                                                                                                                                                                                                                                      +
     \r                                                                                                                                                                                                                                                                                                                                                         +
     INSERT INTO treinamento.class_audit_logs (class_id, action, performed_by, new_data)\r                                                                                                                                                                                                                                                                      +
     VALUES (_class_id, 'ended', auth.uid(), jsonb_build_object('ended_at', _current_time));\r                                                                                                                                                                                                                                                                  +
     \r                                                                                                                                                                                                                                                                                                                                                         +
   ELSE\r                                                                                                                                                                                                                                                                                                                                                       +
     UPDATE treinamento.classes \r                                                                                                                                                                                                                                                                                                                              +
     SET status = _new_status, updated_at = _current_time\r                                                                                                                                                                                                                                                                                                     +
     WHERE id = _class_id;\r                                                                                                                                                                                                                                                                                                                                    +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.has_professor_turma_access(_professor_id uuid, _turma_id uuid, _permission_type text DEFAULT 'view'::text)                                                                                                                                                                                                              +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                  +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                       +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
   SELECT \r                                                                                                                                                                                                                                                                                                                                                    +
     CASE \r                                                                                                                                                                                                                                                                                                                                                    +
       WHEN _permission_type = 'edit' THEN \r                                                                                                                                                                                                                                                                                                                   +
         COALESCE((SELECT can_edit FROM professor_turma_permissions WHERE professor_id = _professor_id AND turma_id = _turma_id), false)\r                                                                                                                                                                                                                      +
       WHEN _permission_type = 'manage_students' THEN \r                                                                                                                                                                                                                                                                                                        +
         COALESCE((SELECT can_manage_students FROM professor_turma_permissions WHERE professor_id = _professor_id AND turma_id = _turma_id), false)\r                                                                                                                                                                                                           +
       ELSE \r                                                                                                                                                                                                                                                                                                                                                  +
         COALESCE((SELECT can_view FROM professor_turma_permissions WHERE professor_id = _professor_id AND turma_id = _turma_id), false)\r                                                                                                                                                                                                                      +
     END;\r                                                                                                                                                                                                                                                                                                                                                     +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.recalc_enrollment_progress(p_enrollment_id uuid)                                                                                                                                                                                                                                                                        +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   v_course_id uuid;\r                                                                                                                                                                                                                                                                                                                                          +
   v_total_lessons integer;\r                                                                                                                                                                                                                                                                                                                                   +
   v_attended integer;\r                                                                                                                                                                                                                                                                                                                                        +
   v_percent integer;\r                                                                                                                                                                                                                                                                                                                                         +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT course_id INTO v_course_id FROM treinamento.enrollments WHERE id = p_enrollment_id;\r                                                                                                                                                                                                                                                                 +
   IF v_course_id IS NULL THEN\r                                                                                                                                                                                                                                                                                                                                +
     RETURN;\r                                                                                                                                                                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   SELECT COUNT(*) INTO v_total_lessons FROM treinamento.lessons WHERE course_id = v_course_id;\r                                                                                                                                                                                                                                                               +
   IF COALESCE(v_total_lessons, 0) = 0 THEN\r                                                                                                                                                                                                                                                                                                                   +
     v_percent := 0;\r                                                                                                                                                                                                                                                                                                                                          +
   ELSE\r                                                                                                                                                                                                                                                                                                                                                       +
     SELECT COUNT(*) INTO v_attended FROM treinamento.attendance WHERE enrollment_id = p_enrollment_id;\r                                                                                                                                                                                                                                                       +
     v_percent := FLOOR((v_attended::numeric * 100) / v_total_lessons)::int;\r                                                                                                                                                                                                                                                                                  +
     IF v_percent > 100 THEN v_percent := 100; END IF;\r                                                                                                                                                                                                                                                                                                        +
     IF v_percent < 0 THEN v_percent := 0; END IF;\r                                                                                                                                                                                                                                                                                                            +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   UPDATE treinamento.enrollments\r                                                                                                                                                                                                                                                                                                                             +
   SET progress_percentage = v_percent, updated_at = now()\r                                                                                                                                                                                                                                                                                                    +
   WHERE id = p_enrollment_id;\r                                                                                                                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.is_admin(_user uuid)                                                                                                                                                                                                                                                                                                    +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                  +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                       +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
   SELECT EXISTS (\r                                                                                                                                                                                                                                                                                                                                            +
     SELECT 1\r                                                                                                                                                                                                                                                                                                                                                 +
     FROM treinamento.admin_users au\r                                                                                                                                                                                                                                                                                                                          +
     WHERE au.user_id = _user\r                                                                                                                                                                                                                                                                                                                                 +
       AND au.active = true\r                                                                                                                                                                                                                                                                                                                                   +
       AND au.status = 'approved'\r                                                                                                                                                                                                                                                                                                                             +
   );\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.reject_admin_user(admin_user_id uuid)                                                                                                                                                                                                                                                                                   +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   IF NOT treinamento.is_admin(auth.uid()) THEN\r                                                                                                                                                                                                                                                                                                               +
     RAISE EXCEPTION 'Access denied. Admin access required.';\r                                                                                                                                                                                                                                                                                                 +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   UPDATE treinamento.admin_users \r                                                                                                                                                                                                                                                                                                                            +
   SET status = 'rejected', active = false, updated_at = now()\r                                                                                                                                                                                                                                                                                                +
   WHERE id = admin_user_id AND status = 'pending';\r                                                                                                                                                                                                                                                                                                           +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF NOT FOUND THEN\r                                                                                                                                                                                                                                                                                                                                          +
     RAISE EXCEPTION 'Admin user not found or already processed.';\r                                                                                                                                                                                                                                                                                            +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.start_turma(p_turma_id uuid, p_user_id uuid)                                                                                                                                                                                                                                                                            +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   v_turma_record RECORD;\r                                                                                                                                                                                                                                                                                                                                     +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   SELECT * INTO v_turma_record FROM treinamento.turmas WHERE id = p_turma_id;\r                                                                                                                                                                                                                                                                                +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF NOT FOUND THEN\r                                                                                                                                                                                                                                                                                                                                          +
     RAISE EXCEPTION 'Turma not found';\r                                                                                                                                                                                                                                                                                                                       +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF v_turma_record.status != 'agendada' THEN\r                                                                                                                                                                                                                                                                                                                +
     RAISE EXCEPTION 'Only scheduled turmas can be started';\r                                                                                                                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   UPDATE treinamento.turmas\r                                                                                                                                                                                                                                                                                                                                  +
   SET \r                                                                                                                                                                                                                                                                                                                                                       +
     status = 'em_andamento', \r                                                                                                                                                                                                                                                                                                                                +
     start_at = now(), \r                                                                                                                                                                                                                                                                                                                                       +
     updated_at = now()\r                                                                                                                                                                                                                                                                                                                                       +
   WHERE id = p_turma_id;\r                                                                                                                                                                                                                                                                                                                                     +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.sync_nomes_unidades()                                                                                                                                                                                                                                                                                                   +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   IF NEW.unit_codes IS NOT NULL AND array_length(NEW.unit_codes, 1) > 0 THEN\r                                                                                                                                                                                                                                                                                 +
     SELECT string_agg(DISTINCT u.grupo, ', ' ORDER BY u.grupo)\r                                                                                                                                                                                                                                                                                               +
     INTO NEW.nomes_unidades\r                                                                                                                                                                                                                                                                                                                                  +
     FROM treinamento.unidades u\r                                                                                                                                                                                                                                                                                                                              +
     WHERE u.codigo_grupo::text = ANY(NEW.unit_codes) AND u.grupo IS NOT NULL;\r                                                                                                                                                                                                                                                                                +
   ELSE\r                                                                                                                                                                                                                                                                                                                                                       +
     NEW.nomes_unidades := NULL;\r                                                                                                                                                                                                                                                                                                                              +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.update_updated_at_column()                                                                                                                                                                                                                                                                                              +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   NEW.updated_at = now();\r                                                                                                                                                                                                                                                                                                                                    +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.sync_password_on_change()                                                                                                                                                                                                                                                                                               +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   old_password text;\r                                                                                                                                                                                                                                                                                                                                         +
   new_password text;\r                                                                                                                                                                                                                                                                                                                                         +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   IF TG_OP = 'UPDATE' THEN\r                                                                                                                                                                                                                                                                                                                                   +
     old_password := COALESCE(OLD.visible_password, '');\r                                                                                                                                                                                                                                                                                                      +
     new_password := COALESCE(NEW.visible_password, '');\r                                                                                                                                                                                                                                                                                                      +
     \r                                                                                                                                                                                                                                                                                                                                                         +
     IF old_password = new_password THEN\r                                                                                                                                                                                                                                                                                                                      +
       RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                            +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   new_password := COALESCE(NEW.visible_password, '');\r                                                                                                                                                                                                                                                                                                        +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   IF LENGTH(new_password) < 6 THEN\r                                                                                                                                                                                                                                                                                                                           +
     RAISE EXCEPTION 'A senha deve ter pelo menos 6 caracteres';\r                                                                                                                                                                                                                                                                                              +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   RAISE NOTICE 'Password updated for user %', NEW.id;\r                                                                                                                                                                                                                                                                                                        +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.upsert_unidade_from_matriz(p_id_matriz uuid, p_codigo_grupo bigint, p_grupo text, p_email text, p_telefone text, p_fase_loja text, p_etapa_loja text, p_modelo_loja text, p_endereco text, p_cidade text, p_estado text, p_uf text, p_cep text, p_created_at_matriz text, p_updated_at_matriz text, p_raw_payload jsonb)+
  RETURNS void                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   v_telefone_bigint BIGINT;\r                                                                                                                                                                                                                                                                                                                                  +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   BEGIN\r                                                                                                                                                                                                                                                                                                                                                      +
     v_telefone_bigint := CAST(regexp_replace(p_telefone, '\D', '', 'g') AS BIGINT);\r                                                                                                                                                                                                                                                                          +
   EXCEPTION WHEN OTHERS THEN\r                                                                                                                                                                                                                                                                                                                                 +
     v_telefone_bigint := NULL;\r                                                                                                                                                                                                                                                                                                                               +
   END;\r                                                                                                                                                                                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   INSERT INTO treinamento.unidades (\r                                                                                                                                                                                                                                                                                                                         +
     id, id_matriz, codigo_grupo, grupo, email, telefone, fase_loja, etapa_loja,\r                                                                                                                                                                                                                                                                              +
     modelo_loja, endereco, cidade, estado, uf, cep, raw_payload_matriz,\r                                                                                                                                                                                                                                                                                      +
     sincronizado_em, created_at, updated_at\r                                                                                                                                                                                                                                                                                                                  +
   )\r                                                                                                                                                                                                                                                                                                                                                          +
   VALUES (\r                                                                                                                                                                                                                                                                                                                                                   +
     p_codigo_grupo::TEXT, p_id_matriz, p_codigo_grupo, p_grupo, p_email, v_telefone_bigint, p_fase_loja, p_etapa_loja,\r                                                                                                                                                                                                                                       +
     p_modelo_loja, p_endereco, p_cidade, p_estado, p_uf, p_cep, p_raw_payload,\r                                                                                                                                                                                                                                                                               +
     NOW(), p_created_at_matriz::timestamp, p_updated_at_matriz::timestamp\r                                                                                                                                                                                                                                                                                    +
   )\r                                                                                                                                                                                                                                                                                                                                                          +
   ON CONFLICT (codigo_grupo)\r                                                                                                                                                                                                                                                                                                                                 +
   DO UPDATE SET\r                                                                                                                                                                                                                                                                                                                                              +
     id = EXCLUDED.id,\r                                                                                                                                                                                                                                                                                                                                        +
     id_matriz = EXCLUDED.id_matriz,\r                                                                                                                                                                                                                                                                                                                          +
     grupo = EXCLUDED.grupo,\r                                                                                                                                                                                                                                                                                                                                  +
     email = EXCLUDED.email,\r                                                                                                                                                                                                                                                                                                                                  +
     telefone = EXCLUDED.telefone,\r                                                                                                                                                                                                                                                                                                                            +
     fase_loja = EXCLUDED.fase_loja,\r                                                                                                                                                                                                                                                                                                                          +
     etapa_loja = EXCLUDED.etapa_loja,\r                                                                                                                                                                                                                                                                                                                        +
     modelo_loja = EXCLUDED.modelo_loja,\r                                                                                                                                                                                                                                                                                                                      +
     endereco = EXCLUDED.endereco,\r                                                                                                                                                                                                                                                                                                                            +
     cidade = EXCLUDED.cidade,\r                                                                                                                                                                                                                                                                                                                                +
     estado = EXCLUDED.estado,\r                                                                                                                                                                                                                                                                                                                                +
     uf = EXCLUDED.uf,\r                                                                                                                                                                                                                                                                                                                                        +
     cep = EXCLUDED.cep,\r                                                                                                                                                                                                                                                                                                                                      +
     raw_payload_matriz = EXCLUDED.raw_payload_matriz,\r                                                                                                                                                                                                                                                                                                        +
     sincronizado_em = NOW(),\r                                                                                                                                                                                                                                                                                                                                 +
     created_at = EXCLUDED.created_at,\r                                                                                                                                                                                                                                                                                                                        +
     updated_at = EXCLUDED.updated_at;\r                                                                                                                                                                                                                                                                                                                        +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   -- This table does not exist in the provided schema, commenting out.\r                                                                                                                                                                                                                                                                                       +
   -- INSERT INTO treinamento.sync_audit_log (entity_type, entity_id, operation, raw_data)\r                                                                                                                                                                                                                                                                    +
   -- VALUES ('unidade', p_id_matriz, 'UPSERT_FROM_MATRIZ', p_raw_payload);\r                                                                                                                                                                                                                                                                                   +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.user_can_access_turma(_user_id uuid, _turma_id uuid)                                                                                                                                                                                                                                                                    +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                  +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                       +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
   SELECT \r                                                                                                                                                                                                                                                                                                                                                    +
     treinamento.is_admin(_user_id) OR\r                                                                                                                                                                                                                                                                                                                        +
     EXISTS (\r                                                                                                                                                                                                                                                                                                                                                 +
       SELECT 1 FROM treinamento.turmas t \r                                                                                                                                                                                                                                                                                                                    +
       WHERE t.id = _turma_id \r                                                                                                                                                                                                                                                                                                                                +
       AND t.responsavel_user_id = _user_id\r                                                                                                                                                                                                                                                                                                                   +
     ) OR\r                                                                                                                                                                                                                                                                                                                                                     +
     EXISTS (\r                                                                                                                                                                                                                                                                                                                                                 +
       SELECT 1 FROM treinamento.enrollments e \r                                                                                                                                                                                                                                                                                                               +
       WHERE e.turma_id = _turma_id \r                                                                                                                                                                                                                                                                                                                          +
       AND e.user_id = _user_id\r                                                                                                                                                                                                                                                                                                                               +
     );\r                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.user_can_access_turma_enrollments(_user_id uuid, _turma_id uuid)                                                                                                                                                                                                                                                        +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                  +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                       +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
   SELECT \r                                                                                                                                                                                                                                                                                                                                                    +
     treinamento.is_admin(_user_id) OR\r                                                                                                                                                                                                                                                                                                                        +
     EXISTS (\r                                                                                                                                                                                                                                                                                                                                                 +
       SELECT 1 FROM treinamento.turmas t \r                                                                                                                                                                                                                                                                                                                    +
       WHERE t.id = _turma_id \r                                                                                                                                                                                                                                                                                                                                +
       AND t.responsavel_user_id = _user_id\r                                                                                                                                                                                                                                                                                                                   +
     );\r                                                                                                                                                                                                                                                                                                                                                       +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.sync_user_password()                                                                                                                                                                                                                                                                                                    +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.trg_update_progress_on_attendance()                                                                                                                                                                                                                                                                                     +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   IF TG_OP = 'INSERT' THEN\r                                                                                                                                                                                                                                                                                                                                   +
     PERFORM treinamento.recalc_enrollment_progress(NEW.enrollment_id);\r                                                                                                                                                                                                                                                                                       +
     RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                              +
   ELSIF TG_OP = 'DELETE' THEN\r                                                                                                                                                                                                                                                                                                                                +
     PERFORM treinamento.recalc_enrollment_progress(OLD.enrollment_id);\r                                                                                                                                                                                                                                                                                       +
     RETURN OLD;\r                                                                                                                                                                                                                                                                                                                                              +
   ELSE\r                                                                                                                                                                                                                                                                                                                                                       +
     RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                              +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.update_collaboration_approvals_updated_at()                                                                                                                                                                                                                                                                             +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   NEW.updated_at = now();\r                                                                                                                                                                                                                                                                                                                                    +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.update_course_lessons_count()                                                                                                                                                                                                                                                                                           +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   IF TG_OP = 'DELETE' THEN\r                                                                                                                                                                                                                                                                                                                                   +
     UPDATE treinamento.courses \r                                                                                                                                                                                                                                                                                                                              +
     SET lessons_count = (\r                                                                                                                                                                                                                                                                                                                                    +
       SELECT COUNT(*) \r                                                                                                                                                                                                                                                                                                                                       +
       FROM treinamento.lessons \r                                                                                                                                                                                                                                                                                                                              +
       WHERE course_id = OLD.course_id\r                                                                                                                                                                                                                                                                                                                        +
     )\r                                                                                                                                                                                                                                                                                                                                                        +
     WHERE id = OLD.course_id;\r                                                                                                                                                                                                                                                                                                                                +
     RETURN OLD;\r                                                                                                                                                                                                                                                                                                                                              +
   ELSE\r                                                                                                                                                                                                                                                                                                                                                       +
     UPDATE treinamento.courses \r                                                                                                                                                                                                                                                                                                                              +
     SET lessons_count = (\r                                                                                                                                                                                                                                                                                                                                    +
       SELECT COUNT(*) \r                                                                                                                                                                                                                                                                                                                                       +
       FROM treinamento.lessons \r                                                                                                                                                                                                                                                                                                                              +
       WHERE course_id = NEW.course_id\r                                                                                                                                                                                                                                                                                                                        +
     )\r                                                                                                                                                                                                                                                                                                                                                        +
     WHERE id = NEW.course_id;\r                                                                                                                                                                                                                                                                                                                                +
     RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                              +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.update_job_positions_updated_at()                                                                                                                                                                                                                                                                                       +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   NEW.updated_at = now();\r                                                                                                                                                                                                                                                                                                                                    +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.update_live_participants_updated_at()                                                                                                                                                                                                                                                                                   +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   NEW.updated_at = now();\r                                                                                                                                                                                                                                                                                                                                    +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.update_nomes_unidades()                                                                                                                                                                                                                                                                                                 +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   IF NEW.unit_codes IS NOT NULL AND array_length(NEW.unit_codes, 1) > 0 THEN\r                                                                                                                                                                                                                                                                                 +
     SELECT array_to_string(array_agg(DISTINCT u.grupo ORDER BY u.grupo), ', ')\r                                                                                                                                                                                                                                                                               +
     INTO NEW.nomes_unidades\r                                                                                                                                                                                                                                                                                                                                  +
     FROM treinamento.unidades u\r                                                                                                                                                                                                                                                                                                                              +
     WHERE u.id = ANY(NEW.unit_codes) AND u.grupo IS NOT NULL;\r                                                                                                                                                                                                                                                                                                +
   ELSE\r                                                                                                                                                                                                                                                                                                                                                       +
     NEW.nomes_unidades := NULL;\r                                                                                                                                                                                                                                                                                                                              +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.update_system_settings(settings_data jsonb)                                                                                                                                                                                                                                                                             +
  RETURNS TABLE(id uuid, system_name text, system_description text, email_notifications boolean, whatsapp_notifications boolean, auto_certificate_generation boolean, certificate_template text, course_approval_required boolean, max_enrollment_per_course integer, timezone text, created_at timestamp with time zone, updated_at timestamp with time zone)  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   v_existing_id uuid;\r                                                                                                                                                                                                                                                                                                                                        +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   IF NOT treinamento.is_admin(auth.uid()) THEN\r                                                                                                                                                                                                                                                                                                               +
     RAISE EXCEPTION 'Access denied. Admin access required.';\r                                                                                                                                                                                                                                                                                                 +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   SELECT s.id INTO v_existing_id \r                                                                                                                                                                                                                                                                                                                            +
   FROM treinamento.system_settings s\r                                                                                                                                                                                                                                                                                                                         +
   LIMIT 1;\r                                                                                                                                                                                                                                                                                                                                                   +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   IF v_existing_id IS NOT NULL THEN\r                                                                                                                                                                                                                                                                                                                          +
     UPDATE treinamento.system_settings \r                                                                                                                                                                                                                                                                                                                      +
     SET \r                                                                                                                                                                                                                                                                                                                                                     +
       system_name = COALESCE((settings_data->>'system_name')::text, system_settings.system_name),\r                                                                                                                                                                                                                                                            +
       system_description = COALESCE((settings_data->>'system_description')::text, system_settings.system_description),\r                                                                                                                                                                                                                                       +
       email_notifications = COALESCE((settings_data->>'email_notifications')::boolean, system_settings.email_notifications),\r                                                                                                                                                                                                                                 +
       whatsapp_notifications = COALESCE((settings_data->>'whatsapp_notifications')::boolean, system_settings.whatsapp_notifications),\r                                                                                                                                                                                                                        +
       auto_certificate_generation = COALESCE((settings_data->>'auto_certificate_generation')::boolean, system_settings.auto_certificate_generation),\r                                                                                                                                                                                                         +
       certificate_template = COALESCE((settings_data->>'certificate_template')::text, system_settings.certificate_template),\r                                                                                                                                                                                                                                 +
       course_approval_required = COALESCE((settings_data->>'course_approval_required')::boolean, system_settings.course_approval_required),\r                                                                                                                                                                                                                  +
       max_enrollment_per_course = (settings_data->>'max_enrollment_per_course')::integer,\r                                                                                                                                                                                                                                                                    +
       timezone = COALESCE((settings_data->>'timezone')::text, system_settings.timezone),\r                                                                                                                                                                                                                                                                     +
       updated_at = now()\r                                                                                                                                                                                                                                                                                                                                     +
     WHERE system_settings.id = v_existing_id;\r                                                                                                                                                                                                                                                                                                                +
   ELSE\r                                                                                                                                                                                                                                                                                                                                                       +
     INSERT INTO treinamento.system_settings (\r                                                                                                                                                                                                                                                                                                                +
       system_name,\r                                                                                                                                                                                                                                                                                                                                           +
       system_description,\r                                                                                                                                                                                                                                                                                                                                    +
       email_notifications,\r                                                                                                                                                                                                                                                                                                                                   +
       whatsapp_notifications,\r                                                                                                                                                                                                                                                                                                                                +
       auto_certificate_generation,\r                                                                                                                                                                                                                                                                                                                           +
       certificate_template,\r                                                                                                                                                                                                                                                                                                                                  +
       course_approval_required,\r                                                                                                                                                                                                                                                                                                                              +
       max_enrollment_per_course,\r                                                                                                                                                                                                                                                                                                                             +
       timezone\r                                                                                                                                                                                                                                                                                                                                               +
     ) VALUES (\r                                                                                                                                                                                                                                                                                                                                               +
       COALESCE((settings_data->>'system_name')::text, 'Cresci e Perdi'),\r                                                                                                                                                                                                                                                                                     +
       COALESCE((settings_data->>'system_description')::text, 'Sistema de Treinamentos'),\r                                                                                                                                                                                                                                                                     +
       COALESCE((settings_data->>'email_notifications')::boolean, true),\r                                                                                                                                                                                                                                                                                      +
       COALESCE((settings_data->>'whatsapp_notifications')::boolean, true),\r                                                                                                                                                                                                                                                                                   +
       COALESCE((settings_data->>'auto_certificate_generation')::boolean, true),\r                                                                                                                                                                                                                                                                              +
       COALESCE((settings_data->>'certificate_template')::text, 'default'),\r                                                                                                                                                                                                                                                                                   +
       COALESCE((settings_data->>'course_approval_required')::boolean, false),\r                                                                                                                                                                                                                                                                                +
       (settings_data->>'max_enrollment_per_course')::integer,\r                                                                                                                                                                                                                                                                                                +
       COALESCE((settings_data->>'timezone')::text, 'America/Sao_Paulo')\r                                                                                                                                                                                                                                                                                      +
     );\r                                                                                                                                                                                                                                                                                                                                                       +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
 \r                                                                                                                                                                                                                                                                                                                                                             +
   RETURN QUERY\r                                                                                                                                                                                                                                                                                                                                               +
   SELECT \r                                                                                                                                                                                                                                                                                                                                                    +
     s.id,\r                                                                                                                                                                                                                                                                                                                                                    +
     s.system_name,\r                                                                                                                                                                                                                                                                                                                                           +
     s.system_description,\r                                                                                                                                                                                                                                                                                                                                    +
     s.email_notifications,\r                                                                                                                                                                                                                                                                                                                                   +
     s.whatsapp_notifications,\r                                                                                                                                                                                                                                                                                                                                +
     s.auto_certificate_generation,\r                                                                                                                                                                                                                                                                                                                           +
     s.certificate_template,\r                                                                                                                                                                                                                                                                                                                                  +
     s.course_approval_required,\r                                                                                                                                                                                                                                                                                                                              +
     s.max_enrollment_per_course,\r                                                                                                                                                                                                                                                                                                                             +
     s.timezone,\r                                                                                                                                                                                                                                                                                                                                              +
     s.created_at,\r                                                                                                                                                                                                                                                                                                                                            +
     s.updated_at\r                                                                                                                                                                                                                                                                                                                                             +
   FROM treinamento.system_settings s\r                                                                                                                                                                                                                                                                                                                         +
   LIMIT 1;\r                                                                                                                                                                                                                                                                                                                                                   +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 
 CREATE OR REPLACE FUNCTION treinamento.validate_unit_codes()                                                                                                                                                                                                                                                                                                   +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                               +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                              +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                              +
  SET search_path TO 'treinamento', 'public'                                                                                                                                                                                                                                                                                                                    +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                      +
   invalid_codes text[];\r                                                                                                                                                                                                                                                                                                                                      +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                        +
   IF NEW.unit_codes IS NOT NULL AND array_length(NEW.unit_codes, 1) > 0 THEN\r                                                                                                                                                                                                                                                                                 +
     SELECT array_agg(code)\r                                                                                                                                                                                                                                                                                                                                   +
     INTO invalid_codes\r                                                                                                                                                                                                                                                                                                                                       +
     FROM unnest(NEW.unit_codes) AS code\r                                                                                                                                                                                                                                                                                                                      +
     WHERE code NOT IN (SELECT id FROM treinamento.unidades);\r                                                                                                                                                                                                                                                                                                 +
     \r                                                                                                                                                                                                                                                                                                                                                         +
     IF invalid_codes IS NOT NULL AND array_length(invalid_codes, 1) > 0 THEN\r                                                                                                                                                                                                                                                                                 +
       RAISE EXCEPTION 'CÃ³digo(s) de unidade invÃ¡lido(s): %. Cadastro nÃ£o aprovado.', \r                                                                                                                                                                                                                                                                     +
         array_to_string(invalid_codes, ', ');\r                                                                                                                                                                                                                                                                                                                +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                    +
   \r                                                                                                                                                                                                                                                                                                                                                           +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                +
 END;\r                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                     +
 ;                                                                                                                                                                                                                                                                                                                                                              +
 

