 CREATE OR REPLACE FUNCTION public.get_franqueados_secure()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
  RETURNS TABLE(id uuid, full_name text, contact text, contact_masked text, owner_type text, is_in_contract boolean, receives_prolabore boolean, prolabore_value numeric, availability text, created_at timestamp with time zone, profile_image text)                                                                                                                                                                                                                                                                                              +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   current_user_role app_role;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- Get current user role                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   current_user_role := get_current_user_role();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- If user is admin, return all data unmasked                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   IF current_user_role = 'admin' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       f.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       f.full_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
       f.contact,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
       f.contact as contact_masked,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
       f.owner_type,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
       f.is_in_contract,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
       f.receives_prolabore,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       f.prolabore_value,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
       f.availability,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
       f.created_at,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
       f.profile_image                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     FROM franqueados f                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     ORDER BY f.created_at DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- If user is franqueado, return limited data with masking                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   ELSIF current_user_role = 'franqueado' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       f.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       f.full_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
       -- Mask contact for other franqueados                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       CASE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
         WHEN length(f.contact) > 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
         THEN '****' || right(f.contact, 4)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
         ELSE '****'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
       END as contact,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
       CASE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
         WHEN length(f.contact) > 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
         THEN '****' || right(f.contact, 4)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
         ELSE '****'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
       END as contact_masked,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
       f.owner_type,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
       f.is_in_contract,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
       -- Hide sensitive financial info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
       false as receives_prolabore,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
       null::numeric as prolabore_value,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
       null::text as availability,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
       f.created_at,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
       f.profile_image                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     FROM franqueados f                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     ORDER BY f.created_at DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- For other roles, return very limited data                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
   ELSE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       f.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       f.full_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
       '****' as contact,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
       '****' as contact_masked,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
       f.owner_type,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
       false as is_in_contract,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
       false as receives_prolabore,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
       null::numeric as prolabore_value,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
       null::text as availability,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
       f.created_at,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
       null::text as profile_image                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     FROM franqueados f                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     ORDER BY f.created_at DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.get_franqueados_unidades_secure()                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
  RETURNS TABLE(id bigint, franqueado_id uuid, unidade_id uuid, created_at timestamp with time zone, updated_at timestamp with time zone, franqueado_full_name text, franqueado_contact text, franqueado_contact_masked text, franqueado_owner_type text, franqueado_profile_image text, franqueado_is_in_contract boolean, unidade_group_code bigint, unidade_group_name text, unidade_city text, unidade_state text, unidade_store_model text, unidade_store_phase text, unidade_cnpj text, unidade_fantasy_name text, unidade_is_active boolean)+
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   current_user_role app_role;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- Get current user role                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   current_user_role := get_current_user_role();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- If user is admin, return all data unmasked                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   IF current_user_role = 'admin' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       fu.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
       fu.franqueado_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
       fu.unidade_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       fu.created_at,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       fu.updated_at,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       f.full_name as franqueado_full_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       f.contact as franqueado_contact,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
       f.contact as franqueado_contact_masked,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
       f.owner_type as franqueado_owner_type,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
       f.profile_image as franqueado_profile_image,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
       f.is_in_contract as franqueado_is_in_contract,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       u.group_code as unidade_group_code,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
       u.group_name as unidade_group_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
       u.city as unidade_city,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
       u.state as unidade_state,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
       u.store_model as unidade_store_model,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       u.store_phase as unidade_store_phase,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       u.cnpj as unidade_cnpj,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
       u.fantasy_name as unidade_fantasy_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
       u.is_active as unidade_is_active                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     FROM franqueados_unidades fu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     JOIN franqueados f ON fu.franqueado_id = f.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     JOIN unidades u ON fu.unidade_id = u.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     ORDER BY fu.created_at DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- If user is franqueado, return limited data with masking                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   ELSIF current_user_role = 'franqueado' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       fu.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
       fu.franqueado_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
       fu.unidade_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       fu.created_at,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       fu.updated_at,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       f.full_name as franqueado_full_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       -- Mask contact for other franqueados                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       CASE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
         WHEN length(f.contact) > 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
         THEN '****' || right(f.contact, 4)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
         ELSE '****'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
       END as franqueado_contact,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
       CASE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
         WHEN length(f.contact) > 4                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
         THEN '****' || right(f.contact, 4)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
         ELSE '****'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
       END as franqueado_contact_masked,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
       f.owner_type as franqueado_owner_type,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
       f.profile_image as franqueado_profile_image,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
       false as franqueado_is_in_contract, -- Hide sensitive info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
       u.group_code as unidade_group_code,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
       u.group_name as unidade_group_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
       u.city as unidade_city,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
       u.state as unidade_state,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
       u.store_model as unidade_store_model,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       u.store_phase as unidade_store_phase,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       null::text as unidade_cnpj, -- Hide sensitive info                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
       u.fantasy_name as unidade_fantasy_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
       u.is_active as unidade_is_active                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     FROM franqueados_unidades fu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     JOIN franqueados f ON fu.franqueado_id = f.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     JOIN unidades u ON fu.unidade_id = u.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     ORDER BY fu.created_at DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- For other roles, return very limited data                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
   ELSE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       fu.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
       fu.franqueado_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
       fu.unidade_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       fu.created_at,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       fu.updated_at,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       f.full_name as franqueado_full_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       '****' as franqueado_contact,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
       '****' as franqueado_contact_masked,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       f.owner_type as franqueado_owner_type,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
       null::text as franqueado_profile_image,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
       false as franqueado_is_in_contract,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
       u.group_code as unidade_group_code,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
       u.group_name as unidade_group_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
       u.city as unidade_city,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
       u.state as unidade_state,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
       null::text as unidade_store_model,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
       null::text as unidade_store_phase,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
       null::text as unidade_cnpj,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
       u.fantasy_name as unidade_fantasy_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
       u.is_active as unidade_is_active                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     FROM franqueados_unidades fu                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     JOIN franqueados f ON fu.franqueado_id = f.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     JOIN unidades u ON fu.unidade_id = u.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     ORDER BY fu.created_at DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.get_nomes_para_normalizacao()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
  RETURNS TABLE(id text, tabela text, nome_atual text, nome_normalizado text)                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- Verificar se o usuÃ¡rio Ã© admin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   IF NOT has_role(auth.uid(), 'admin') THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     RAISE EXCEPTION 'Acesso negado. Apenas administradores podem executar esta funÃ§Ã£o.';                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
   -- Franqueados                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
   SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     f.id::text,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     'franqueados'::text as tabela,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     f.full_name as nome_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     to_title_case(f.full_name) as nome_normalizado                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   FROM franqueados f                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   WHERE f.full_name != to_title_case(f.full_name)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     AND f.full_name IS NOT NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     AND trim(f.full_name) != ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   UNION ALL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Clientes (id Ã© bigint, converter para text)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
   SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     c.id::text,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     'clientes'::text as tabela,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     c.full_name as nome_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     to_title_case(c.full_name) as nome_normalizado                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   FROM clientes c                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
   WHERE c.full_name != to_title_case(c.full_name)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     AND c.full_name IS NOT NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     AND trim(c.full_name) != ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   UNION ALL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Colaboradores Interno                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     ci.id::text,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     'colaboradores_interno'::text as tabela,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     ci.employee_name as nome_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     to_title_case(ci.employee_name) as nome_normalizado                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   FROM colaboradores_interno ci                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   WHERE ci.employee_name != to_title_case(ci.employee_name)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     AND ci.employee_name IS NOT NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
     AND trim(ci.employee_name) != ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   UNION ALL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Colaboradores Loja                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     cl.id::text,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     'colaboradores_loja'::text as tabela,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     cl.employee_name as nome_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     to_title_case(cl.employee_name) as nome_normalizado                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   FROM colaboradores_loja cl                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   WHERE cl.employee_name != to_title_case(cl.employee_name)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     AND cl.employee_name IS NOT NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
     AND trim(cl.employee_name) != ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   ORDER BY tabela, nome_atual;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.get_unidades_para_normalizacao()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
  RETURNS TABLE(group_code bigint, nome_atual text, nome_correto text, id_unidades uuid, id_unidades_old text)                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- Verifica se o usuÃ¡rio Ã© admin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   IF NOT has_role(auth.uid(), 'admin') THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     RAISE EXCEPTION 'Acesso negado. Apenas administradores podem executar esta funÃ§Ã£o.';                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
   SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     u.group_code,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     u.group_name as nome_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     uo.group_name as nome_correto,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     u.id as id_unidades,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     uo.id as id_unidades_old                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   FROM unidades u                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
   INNER JOIN unidades_old uo ON u.group_code = uo.group_code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   WHERE u.group_name != uo.group_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     AND uo.group_name IS NOT NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     AND trim(uo.group_name) != ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
   ORDER BY u.group_code;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.get_user_permissions(_user_id uuid)                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
  RETURNS TABLE(table_name text, can_create boolean, can_read boolean, can_update boolean, can_delete boolean)                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   user_role app_role;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- Admin tem acesso total a tudo                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   IF has_role(_user_id, 'admin') THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       pt.table_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       true as can_create,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
       true as can_read,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
       true as can_update,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
       true as can_delete                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     FROM permission_tables pt;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     RETURN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Obter role do usuÃ¡rio                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
   SELECT ur.role INTO user_role                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   FROM user_roles ur                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   WHERE ur.user_id = _user_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   LIMIT 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Retornar combinaÃ§Ã£o de permissÃµes especÃ­ficas e do role                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
   SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     pt.table_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     COALESCE(utp.can_create, rtp.can_create, false) as can_create,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     COALESCE(utp.can_read, rtp.can_read, false) as can_read,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     COALESCE(utp.can_update, rtp.can_update, false) as can_update,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     COALESCE(utp.can_delete, rtp.can_delete, false) as can_delete                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
   FROM permission_tables pt                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
   LEFT JOIN user_table_permissions utp ON utp.table_name = pt.table_name AND utp.user_id = _user_id                                                                                                                                                                                                                                                                                                                                                                                                                                               +
   LEFT JOIN role_table_permissions rtp ON rtp.table_name = pt.table_name AND rtp.role = user_role;                                                                                                                                                                                                                                                                                                                                                                                                                                                +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.get_users_with_emails()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
  RETURNS TABLE(id uuid, user_id uuid, full_name text, phone_number text, status text, notes text, created_at timestamp with time zone, updated_at timestamp with time zone, created_by uuid, email text)                                                                                                                                                                                                                                                                                                                                          +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     p.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     p.user_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     p.full_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     p.phone_number,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     p.status,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     p.notes,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     p.created_at,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     p.updated_at,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     p.created_by,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     au.email                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   FROM profiles p                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
   LEFT JOIN auth.users au ON p.user_id = au.id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
   ORDER BY p.created_at DESC;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.handle_new_user()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- Inserir profile apenas se os dados necessÃ¡rios estiverem disponÃ­veis                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   IF NEW.raw_user_meta_data ? 'full_name' AND NEW.raw_user_meta_data ? 'phone_number' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     INSERT INTO public.profiles (user_id, full_name, phone_number, notes, created_by)                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
       NEW.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
       NEW.raw_user_meta_data->>'full_name',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       NEW.raw_user_meta_data->>'phone_number',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
       NEW.raw_user_meta_data->>'notes',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
       COALESCE((NEW.raw_user_meta_data->>'created_by')::UUID, NEW.id)                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
   RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.has_role(_user_id uuid, _role app_role)                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   SELECT EXISTS (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     SELECT 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     FROM public.user_roles                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     WHERE user_id = _user_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
       AND role = _role                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
   )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.has_table_permission(_user_id uuid, _table_name text, _permission text)                                                                                                                                                                                                                                                                                                                                                                                                                                         +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   user_role app_role;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   has_permission BOOLEAN;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- Admin sempre tem permissÃ£o total                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
   IF has_role(_user_id, 'admin') THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     RETURN true;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Obter o role do usuÃ¡rio                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   SELECT role INTO user_role                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   FROM user_roles                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
   WHERE user_id = _user_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   LIMIT 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Verificar permissÃ£o especÃ­fica do usuÃ¡rio (override)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
   CASE _permission                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     WHEN 'create' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
       SELECT can_create INTO has_permission                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       FROM user_table_permissions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
       WHERE user_id = _user_id AND table_name = _table_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     WHEN 'read' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       SELECT can_read INTO has_permission                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
       FROM user_table_permissions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
       WHERE user_id = _user_id AND table_name = _table_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     WHEN 'update' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
       SELECT can_update INTO has_permission                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       FROM user_table_permissions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
       WHERE user_id = _user_id AND table_name = _table_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     WHEN 'delete' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
       SELECT can_delete INTO has_permission                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       FROM user_table_permissions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
       WHERE user_id = _user_id AND table_name = _table_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   END CASE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Se hÃ¡ permissÃ£o especÃ­fica, usar ela                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
   IF has_permission IS NOT NULL THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
     RETURN has_permission;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Se nÃ£o hÃ¡ permissÃ£o especÃ­fica, verificar permissÃ£o do role                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   CASE _permission                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     WHEN 'create' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
       SELECT can_create INTO has_permission                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       FROM role_table_permissions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
       WHERE role = user_role AND table_name = _table_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     WHEN 'read' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       SELECT can_read INTO has_permission                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
       FROM role_table_permissions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
       WHERE role = user_role AND table_name = _table_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     WHEN 'update' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
       SELECT can_update INTO has_permission                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       FROM role_table_permissions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
       WHERE role = user_role AND table_name = _table_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     WHEN 'delete' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
       SELECT can_delete INTO has_permission                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
       FROM role_table_permissions                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
       WHERE role = user_role AND table_name = _table_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   END CASE;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Retornar permissÃ£o do role ou false se nÃ£o encontrada                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   RETURN COALESCE(has_permission, false);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.log_franqueado_access(_franqueado_id uuid, _action text, _accessed_fields text[] DEFAULT NULL::text[])                                                                                                                                                                                                                                                                                                                                                                                                          +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   VALUES (auth.uid(), _franqueado_id, _action, _accessed_fields);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.normalizar_nome_pessoa(p_id text, p_tabela text)                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   v_nome_atual text;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   v_nome_normalizado text;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   v_rows_affected integer;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- Verificar se o usuÃ¡rio Ã© admin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   IF NOT has_role(auth.uid(), 'admin') THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     RAISE EXCEPTION 'Acesso negado. Apenas administradores podem executar esta funÃ§Ã£o.';                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Processar baseado na tabela                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
   IF p_tabela = 'franqueados' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     SELECT full_name INTO v_nome_atual FROM franqueados WHERE id = p_id::uuid;                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     v_nome_normalizado := to_title_case(v_nome_atual);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     UPDATE franqueados                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     SET full_name = v_nome_normalizado, updated_at = now()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     WHERE id = p_id::uuid;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     GET DIAGNOSTICS v_rows_affected = ROW_COUNT;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   ELSIF p_tabela = 'clientes' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     SELECT full_name INTO v_nome_atual FROM clientes WHERE id = p_id::bigint;                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     v_nome_normalizado := to_title_case(v_nome_atual);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     UPDATE clientes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     SET full_name = v_nome_normalizado, updated_at = now()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     WHERE id = p_id::bigint;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     GET DIAGNOSTICS v_rows_affected = ROW_COUNT;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   ELSIF p_tabela = 'colaboradores_interno' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     SELECT employee_name INTO v_nome_atual FROM colaboradores_interno WHERE id = p_id::uuid;                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     v_nome_normalizado := to_title_case(v_nome_atual);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     UPDATE colaboradores_interno                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     SET employee_name = v_nome_normalizado, updated_at = now()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     WHERE id = p_id::uuid;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     GET DIAGNOSTICS v_rows_affected = ROW_COUNT;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   ELSIF p_tabela = 'colaboradores_loja' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     SELECT employee_name INTO v_nome_atual FROM colaboradores_loja WHERE id = p_id::uuid;                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     v_nome_normalizado := to_title_case(v_nome_atual);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     UPDATE colaboradores_loja                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     SET employee_name = v_nome_normalizado, updated_at = now()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     WHERE id = p_id::uuid;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     GET DIAGNOSTICS v_rows_affected = ROW_COUNT;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   ELSE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     RAISE EXCEPTION 'Tabela invÃ¡lida: %', p_tabela;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Log da operaÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
   INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     CASE WHEN p_tabela = 'franqueados' THEN p_id::uuid ELSE null END,                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     'NORMALIZAR_NOME - tabela: ' || p_tabela || ' - de: "' || v_nome_atual || '" para: "' || v_nome_normalizado || '"',                                                                                                                                                                                                                                                                                                                                                                                                                           +
     ARRAY['full_name', 'employee_name']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   RETURN v_rows_affected > 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.normalizar_nome_unidade(p_group_code bigint)                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   v_nome_correto text;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
   v_nome_atual text;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- Verifica se o usuÃ¡rio Ã© admin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   IF NOT has_role(auth.uid(), 'admin') THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     RAISE EXCEPTION 'Acesso negado. Apenas administradores podem executar esta funÃ§Ã£o.';                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Busca o nome correto da unidades_old                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
   SELECT uo.group_name, u.group_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   INTO v_nome_correto, v_nome_atual                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
   FROM unidades_old uo                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
   INNER JOIN unidades u ON u.group_code = uo.group_code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   WHERE uo.group_code = p_group_code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
     AND uo.group_name IS NOT NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     AND trim(uo.group_name) != '';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Se nÃ£o encontrou ou os nomes jÃ¡ sÃ£o iguais, retorna false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
   IF v_nome_correto IS NULL OR v_nome_correto = v_nome_atual THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     RETURN false;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Atualiza o nome na tabela unidades                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   UPDATE unidades                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
   SET                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     group_name = v_nome_correto,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     updated_at = now()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
   WHERE group_code = p_group_code;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Log da operaÃ§Ã£o (se houver tabela de auditoria)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
   INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     null,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     'NORMALIZAR_NOME_UNIDADE - group_code: ' || p_group_code::text || ' - de: "' || v_nome_atual || '" para: "' || v_nome_correto || '"',                                                                                                                                                                                                                                                                                                                                                                                                         +
     ARRAY['group_name']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   RETURN true;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.normalizar_todas_unidades()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  RETURNS json[]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     unidade_record RECORD;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     resultado json;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     resultados json[] := '{}';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     total_count integer := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     success_count integer := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     error_count integer := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     error_message text;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     -- Verificar se o usuÃ¡rio Ã© administrador                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     IF NOT has_role(auth.uid(), 'admin') THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
         RAISE EXCEPTION 'Acesso negado. Apenas administradores podem executar esta funÃ§Ã£o.';                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     -- Log inÃ­cio da operaÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
         auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
         null,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
         'NORMALIZACAO_TODAS_INICIADA',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
         ARRAY['group_name']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     -- Buscar todas as unidades que precisam ser normalizadas                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     FOR unidade_record IN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
         SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
             u.group_code,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
             u.group_name as nome_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
             uo.group_name as nome_correto                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
         FROM unidades u                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
         INNER JOIN unidades_old uo ON u.group_code = uo.group_code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
         WHERE u.group_name != uo.group_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             AND uo.group_name IS NOT NULL                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
             AND trim(uo.group_name) != ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
         ORDER BY u.group_code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     LOOP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
         total_count := total_count + 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
         BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
             -- Tentar atualizar a unidade individual                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
             UPDATE unidades                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             SET                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 group_name = unidade_record.nome_correto,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                 updated_at = now()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             WHERE group_code = unidade_record.group_code;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             -- Verificar se a atualizaÃ§Ã£o foi bem-sucedida                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
             IF FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                 success_count := success_count + 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                 resultado := json_build_object(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                     'group_code', unidade_record.group_code,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                     'nome_anterior', unidade_record.nome_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                     'nome_novo', unidade_record.nome_correto,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
                     'sucesso', true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                 );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 -- Log da normalizaÃ§Ã£o individual bem-sucedida                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                 INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                 VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                     auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                     null,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                     'NORMALIZACAO_UNIDADE_SUCESSO - group_code: ' || unidade_record.group_code || ' - de: "' || unidade_record.nome_atual || '" para: "' || unidade_record.nome_correto || '"',                                                                                                                                                                                                                                                                                                                                                   +
                     ARRAY['group_name']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
                 );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             ELSE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                 error_count := error_count + 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 error_message := 'Nenhuma linha foi atualizada para group_code: ' || unidade_record.group_code;                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 resultado := json_build_object(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                     'group_code', unidade_record.group_code,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                     'nome_anterior', unidade_record.nome_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                     'nome_novo', unidade_record.nome_correto,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
                     'sucesso', false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                 );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 -- Log do erro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
                 INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                 VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                     auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                     null,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                     'NORMALIZACAO_UNIDADE_ERRO - ' || error_message,                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                     ARRAY['group_name']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
                 );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
         EXCEPTION WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             error_count := error_count + 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             error_message := SQLERRM;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             resultado := json_build_object(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                 'group_code', unidade_record.group_code,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                 'nome_anterior', unidade_record.nome_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                 'nome_novo', unidade_record.nome_correto,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                 'sucesso', false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
             );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             -- Log do erro com detalhes da exceÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
             INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                 auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                 null,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
                 'NORMALIZACAO_UNIDADE_ERRO - group_code: ' || unidade_record.group_code || ' - ' || error_message || ' - SQLSTATE: ' || SQLSTATE,                                                                                                                                                                                                                                                                                                                                                                                                 +
                 ARRAY['group_name']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
             );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
         END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
         resultados := array_append(resultados, resultado);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     END LOOP;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     -- Log final da operaÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
         auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
         null,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
         'NORMALIZACAO_TODAS_FINALIZADA - Total: ' || total_count || ' - Sucessos: ' || success_count || ' - Erros: ' || error_count,                                                                                                                                                                                                                                                                                                                                                                                                              +
         ARRAY['group_name']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     RETURN resultados;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.normalizar_todos_contatos()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  RETURNS json[]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     franqueado_record RECORD;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     resultado json;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     resultados json[] := '{}';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     total_count integer := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     success_count integer := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     error_count integer := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     error_message text;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     -- Verificar se o usuÃ¡rio Ã© administrador                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     IF NOT has_role(auth.uid(), 'admin') THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
         RAISE EXCEPTION 'Acesso negado. Apenas administradores podem executar esta funÃ§Ã£o.';                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     -- Log inÃ­cio da operaÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
         auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
         null,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
         'NORMALIZACAO_CONTATOS_INICIADA',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
         ARRAY['contact']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     -- Buscar todos os franqueados que precisam normalizaÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     FOR franqueado_record IN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
         SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
             f.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
             f.full_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
             f.contact as contato_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
             regexp_replace(f.contact, '[^0-9]', '', 'g') as contato_normalizado                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
         FROM franqueados f                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
         WHERE f.contact ~ '[^0-9]'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
         ORDER BY f.full_name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     LOOP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
         total_count := total_count + 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
         BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
             -- Tentar atualizar o contato individual                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
             UPDATE franqueados                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
             SET                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 contact = franqueado_record.contato_normalizado,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                 updated_at = now()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             WHERE id = franqueado_record.id;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             -- Verificar se a atualizaÃ§Ã£o foi bem-sucedida                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
             IF FOUND THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                 success_count := success_count + 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                 resultado := json_build_object(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                     'franqueado_id', franqueado_record.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                     'nome_franqueado', franqueado_record.full_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                     'contato_anterior', franqueado_record.contato_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                     'contato_novo', franqueado_record.contato_normalizado,                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                     'sucesso', true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                 );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 -- Log da normalizaÃ§Ã£o individual bem-sucedida                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                 INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                 VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                     auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                     franqueado_record.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                     'NORMALIZACAO_CONTATO_SUCESSO - de: "' || franqueado_record.contato_atual || '" para: "' || franqueado_record.contato_normalizado || '"',                                                                                                                                                                                                                                                                                                                                                                                     +
                     ARRAY['contact']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                 );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             ELSE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                 error_count := error_count + 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 error_message := 'Nenhuma linha foi atualizada para franqueado_id: ' || franqueado_record.id;                                                                                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 resultado := json_build_object(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                     'franqueado_id', franqueado_record.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                     'nome_franqueado', franqueado_record.full_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                     'contato_anterior', franqueado_record.contato_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                     'contato_novo', franqueado_record.contato_normalizado,                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                     'sucesso', false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                 );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 -- Log do erro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
                 INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                 VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                     auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                     franqueado_record.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                     'NORMALIZACAO_CONTATO_ERRO - ' || error_message,                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                     ARRAY['contact']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                 );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
         EXCEPTION WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             error_count := error_count + 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             error_message := SQLERRM;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             resultado := json_build_object(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                 'franqueado_id', franqueado_record.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                 'nome_franqueado', franqueado_record.full_name,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 'contato_anterior', franqueado_record.contato_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                 'contato_novo', franqueado_record.contato_normalizado,                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                 'sucesso', false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
             );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             -- Log do erro com detalhes da exceÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
             INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                 auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                 franqueado_record.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
                 'NORMALIZACAO_CONTATO_ERRO - ' || error_message || ' - SQLSTATE: ' || SQLSTATE,                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 ARRAY['contact']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
             );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
         END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
         resultados := array_append(resultados, resultado);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     END LOOP;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     -- Log final da operaÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
         auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
         null,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
         'NORMALIZACAO_CONTATOS_FINALIZADA - Total: ' || total_count || ' - Sucessos: ' || success_count || ' - Erros: ' || error_count,                                                                                                                                                                                                                                                                                                                                                                                                           +
         ARRAY['contact']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     RETURN resultados;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.normalizar_todos_nomes()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
  RETURNS json[]                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     nome_record RECORD;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     resultado json;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     resultados json[] := '{}';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     total_count integer := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     success_count integer := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     error_count integer := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     error_message text;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     -- Verificar se o usuÃ¡rio Ã© administrador                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     IF NOT has_role(auth.uid(), 'admin') THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
         RAISE EXCEPTION 'Acesso negado. Apenas administradores podem executar esta funÃ§Ã£o.';                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     -- Log inÃ­cio da operaÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
         auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
         null,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
         'NORMALIZACAO_NOMES_INICIADA',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
         ARRAY['full_name', 'employee_name']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     -- Processar cada registro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     FOR nome_record IN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
         SELECT * FROM get_nomes_para_normalizacao()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     LOOP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
         total_count := total_count + 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
         BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
             -- Tentar normalizar o nome                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
             IF normalizar_nome_pessoa(nome_record.id, nome_record.tabela) THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
                 success_count := success_count + 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                 resultado := json_build_object(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                     'id', nome_record.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                     'tabela', nome_record.tabela,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
                     'nome_anterior', nome_record.nome_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                     'nome_novo', nome_record.nome_normalizado,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
                     'sucesso', true                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                 );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             ELSE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                 error_count := error_count + 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 resultado := json_build_object(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                     'id', nome_record.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                     'tabela', nome_record.tabela,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
                     'nome_anterior', nome_record.nome_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                     'nome_novo', nome_record.nome_normalizado,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
                     'sucesso', false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                 );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
         EXCEPTION WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
             error_count := error_count + 1;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
             error_message := SQLERRM;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             resultado := json_build_object(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                 'id', nome_record.id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
                 'tabela', nome_record.tabela,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
                 'nome_anterior', nome_record.nome_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
                 'nome_novo', nome_record.nome_normalizado,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
                 'sucesso', false,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
                 'erro', error_message                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
             );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             -- Log do erro                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
             INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
             VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                 auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                 CASE WHEN nome_record.tabela = 'franqueados' THEN nome_record.id ELSE null END,                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                 'NORMALIZACAO_NOME_ERRO - ' || error_message,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
                 ARRAY['full_name', 'employee_name']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
             );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
         END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
         resultados := array_append(resultados, resultado);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     END LOOP;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     -- Log final da operaÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
         auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
         null,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
         'NORMALIZACAO_NOMES_FINALIZADA - Total: ' || total_count || ' - Sucessos: ' || success_count || ' - Erros: ' || error_count,                                                                                                                                                                                                                                                                                                                                                                                                              +
         ARRAY['full_name', 'employee_name']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     RETURN resultados;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.notify_table_changes()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   webhook_url TEXT;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
   payload_data JSONB;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- URL da edge function webhook-dispatcher                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   webhook_url := 'https://zqexpclhdrbnevxheiax.supabase.co/functions/v1/webhook-dispatcher';                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Montar payload no formato legacy compatÃ­vel com matriz-webhook                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
   -- Formato: { "topic": "generic", "payload": { "table": "...", "record": {...} } }                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   payload_data := jsonb_build_object(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     'topic', 'generic',                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     'payload', jsonb_build_object(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
       'table', TG_TABLE_NAME,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
       'record', CASE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
         WHEN TG_OP = 'DELETE' THEN to_jsonb(OLD)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
         ELSE to_jsonb(NEW)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
       END                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Enviar para webhook-dispatcher de forma assÃ­ncrona                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   PERFORM net.http_post(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     url := webhook_url,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
     body := payload_data,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     headers := jsonb_build_object(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
       'Content-Type', 'application/json'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     )                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   RETURN COALESCE(NEW, OLD);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.notify_webhook()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
   -- IMPORTANTE: Substitua pela URL da Edge Function que criaremos a seguir.\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
   webhook_url TEXT := 'https://qrdewkryvpwvdxygtxve.supabase.co/functions/v1/matriz-webhook';\r                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   payload JSONB;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   -- Monta o payload JSON com o nome da tabela e os dados da linha.\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   payload := jsonb_build_object(\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     'table', TG_TABLE_NAME,\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     'record', to_jsonb(NEW)\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   );\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   -- Envia os dados para o webhook de forma assÃ­ncrona, sem bloquear a transaÃ§Ã£o.\r                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   PERFORM net.http_post(\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     url := webhook_url,\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     body := payload,\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     headers := '{"Content-Type": "application/json"}'::JSONB\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
   );\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
 END;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.reenviar_webhooks_normalizacao()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
  RETURNS json                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   total_atualizados integer := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- Verifica se o usuÃ¡rio Ã© admin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   IF NOT has_role(auth.uid(), 'admin') THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     RAISE EXCEPTION 'Acesso negado. Apenas administradores podem executar esta funÃ§Ã£o.';                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Faz um UPDATE "dummy" em todos os franqueados normalizados na Ãºltima hora                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Isso vai disparar o trigger notify_table_changes automaticamente                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   UPDATE franqueados                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   SET updated_at = updated_at  -- UPDATE sem mudanÃ§a real, sÃ³ para disparar trigger                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   WHERE updated_at > NOW() - INTERVAL '1 hour';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   GET DIAGNOSTICS total_atualizados = ROW_COUNT;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Log da operaÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
   INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     null,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     'REENVIO_WEBHOOKS_NORMALIZACAO - Total: ' || total_atualizados || ' webhooks reenviados',                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
     ARRAY['updated_at']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   RETURN json_build_object(                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     'sucesso', true,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
     'total_atualizados', total_atualizados,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     'mensagem', total_atualizados || ' webhooks reenviados com sucesso'                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.set_updated_at()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 begin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   NEW.updated_at := now();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   return NEW;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 end;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.can_access_sensitive_data(_franqueado_id uuid DEFAULT NULL::uuid)                                                                                                                                                                                                                                                                                                                                                                                                                                               +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     has_role(auth.uid(), 'admin')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
     OR                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     (_franqueado_id IS NOT NULL AND EXISTS (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
       SELECT 1 FROM franqueados                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
       WHERE id = _franqueado_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
         AND user_id = auth.uid()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
         AND has_role(auth.uid(), 'franqueado')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     ));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.get_all_unidades_for_sync()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  RETURNS SETOF public.unidades                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   RETURN QUERY SELECT * FROM public.unidades;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
 END;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.get_contatos_para_normalizacao()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
  RETURNS TABLE(franqueado_id uuid, nome_franqueado text, contato_atual text, contato_normalizado text)                                                                                                                                                                                                                                                                                                                                                                                                                                            +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- Verifica se o usuÃ¡rio Ã© admin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   IF NOT has_role(auth.uid(), 'admin') THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     RAISE EXCEPTION 'Acesso negado. Apenas administradores podem executar esta funÃ§Ã£o.';                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   RETURN QUERY                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
   SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     f.id as franqueado_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     f.full_name as nome_franqueado,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     f.contact as contato_atual,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     regexp_replace(f.contact, '[^0-9]', '', 'g') as contato_normalizado                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   FROM franqueados f                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   WHERE f.contact ~ '[^0-9]'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   ORDER BY f.full_name;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.get_current_user_role()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
  RETURNS app_role                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  LANGUAGE sql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  STABLE SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   SELECT role                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   FROM public.user_roles                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
   WHERE user_id = auth.uid()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   LIMIT 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.log_vinculo_access(_vinculo_id bigint, _action text, _accessed_fields text[] DEFAULT NULL::text[])                                                                                                                                                                                                                                                                                                                                                                                                              +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   VALUES (auth.uid(), null, _action || ' - vinculo_id: ' || _vinculo_id::text, _accessed_fields);                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.normalizar_contato_franqueado(p_franqueado_id uuid)                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   v_contato_atual text;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   v_contato_normalizado text;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- Verifica se o usuÃ¡rio Ã© admin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   IF NOT has_role(auth.uid(), 'admin') THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     RAISE EXCEPTION 'Acesso negado. Apenas administradores podem executar esta funÃ§Ã£o.';                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Busca o contato atual e calcula o normalizado                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   SELECT                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
     f.contact,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     regexp_replace(f.contact, '[^0-9]', '', 'g')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
   INTO v_contato_atual, v_contato_normalizado                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   FROM franqueados f                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   WHERE f.id = p_franqueado_id                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
     AND f.contact ~ '[^0-9]';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Se nÃ£o encontrou ou jÃ¡ estÃ¡ normalizado, retorna false                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
   IF v_contato_normalizado IS NULL OR v_contato_atual = v_contato_normalizado THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     RETURN false;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Atualiza o contato na tabela franqueados                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   UPDATE franqueados                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   SET                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     contact = v_contato_normalizado,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
     updated_at = now()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
   WHERE id = p_franqueado_id;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Log da operaÃ§Ã£o                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
   INSERT INTO franqueados_audit_log (user_id, franqueado_id, action, accessed_fields)                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   VALUES (                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
     auth.uid(),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     p_franqueado_id,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
     'NORMALIZAR_CONTATO - de: "' || v_contato_atual || '" para: "' || v_contato_normalizado || '"',                                                                                                                                                                                                                                                                                                                                                                                                                                               +
     ARRAY['contact']                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   RETURN true;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.tg_set_updated_at()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO ''                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 begin                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   new.updated_at := now();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   return new;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 end;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.to_title_case(input_text text)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  RETURNS text                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  IMMUTABLE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 DECLARE                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   words text[];                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   result text := '';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   word text;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   IF input_text IS NULL OR trim(input_text) = '' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
     RETURN input_text;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Split por espaÃ§os                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   words := string_to_array(lower(trim(input_text)), ' ');                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Processar cada palavra                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
   FOREACH word IN ARRAY words                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   LOOP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
     IF word != '' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
       -- Primeira letra maiÃºscula, resto minÃºsculo                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
       result := result || initcap(word) || ' ';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
     END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
   END LOOP;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   -- Remover espaÃ§o final                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
   RETURN trim(result);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.trg_franqueados_normaliza_owner_type()                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   -- Normaliza comparando em minÃºsculas                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          +
   IF lower(NEW.owner_type) = 'socio' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     NEW.owner_type := 'SÃ³cio';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   ELSIF lower(NEW.owner_type) = 'principal' THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
     NEW.owner_type := 'Principal';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.update_profiles_updated_at()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SET search_path TO 'public'                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   NEW.updated_at = now();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
   RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.update_updated_at_column()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 AS $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             +
   NEW.updated_at = NOW();                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
   RETURN NEW;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.reconcile_user_fks(p_orig_id uuid, p_dest_id uuid)                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
  RETURNS void                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   -- auth.*\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   UPDATE auth.identities SET user_id = p_dest_id WHERE user_id = p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   UPDATE auth.sessions   SET user_id = p_dest_id WHERE user_id = p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'auth' AND table_name = 'mfa_factors') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                           +
     UPDATE auth.mfa_factors SET user_id = p_dest_id WHERE user_id = p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'auth' AND table_name = 'oauth_authorizations') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                  +
     UPDATE auth.oauth_authorizations SET user_id = p_dest_id WHERE user_id = p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'auth' AND table_name = 'oauth_consents') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                        +
     UPDATE auth.oauth_consents SET user_id = p_dest_id WHERE user_id = p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'auth' AND table_name = 'one_time_tokens') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                       +
     UPDATE auth.one_time_tokens SET user_id = p_dest_id WHERE user_id = p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                              +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   -- public e schema alvo\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
   IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_roles') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                          +
     UPDATE public.user_roles SET user_id = p_dest_id WHERE user_id = p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'profiles') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                            +
     UPDATE public.profiles SET user_id = p_dest_id WHERE user_id = p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'franqueados_audit_log') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                               +
     UPDATE public.franqueados_audit_log SET user_id = p_dest_id WHERE user_id = p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                      +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'user_table_permissions') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                              +
     UPDATE public.user_table_permissions SET created_by = p_dest_id WHERE created_by = p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                                               +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
   IF EXISTS (SELECT 1 FROM information_schema.schemata WHERE schema_name = 'public') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
     -- exemplos no schema de treinamento (ajuste conforme seus objetos)\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'profiles') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                          +
       EXECUTE format('UPDATE %I.profiles SET id = $1 WHERE id = $2', 'public') USING p_dest_id, p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                                      +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'admin_users') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                       +
       EXECUTE format('UPDATE %I.admin_users SET user_id = $1 WHERE user_id = $2', 'public') USING p_dest_id, p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                         +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'lessons') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                           +
       EXECUTE format('UPDATE %I.lessons SET created_by = $1 WHERE created_by = $2', 'public') USING p_dest_id, p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                       +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'tests') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                             +
       EXECUTE format('UPDATE %I.tests SET created_by = $1 WHERE created_by = $2', 'public') USING p_dest_id, p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                         +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'test_submissions') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                  +
       EXECUTE format('UPDATE %I.test_submissions SET user_id = $1 WHERE user_id = $2', 'public') USING p_dest_id, p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                                    +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
 \r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                +
     IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'turmas') THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                            +
       EXECUTE format('UPDATE %I.turmas SET responsavel_user_id = $1 WHERE responsavel_user_id = $2', 'public') USING p_dest_id, p_orig_id;\r                                                                                                                                                                                                                                                                                                                                                                                                      +
     END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
 END;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 
 CREATE OR REPLACE FUNCTION public.auth_users_update_reconcile()                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  +
  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
  SECURITY DEFINER                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 AS $function$\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
 DECLARE\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
   v_dest_id uuid;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               +
 BEGIN\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           +
   SELECT dest_id INTO v_dest_id FROM public.user_id_map WHERE orig_id = NEW.id;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
   IF v_dest_id IS NOT NULL AND v_dest_id <> NEW.id THEN\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         +
     PERFORM public.reconcile_user_fks(NEW.id, v_dest_id);\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
   END IF;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       +
   RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   +
 END;\r                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            +
 $function$                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        +
 ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 +
 

